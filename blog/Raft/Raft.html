<!doctype html>
<html>
<head>
<meta charset='UTF-8'><meta name='viewport' content='width=device-width initial-scale=1'>

<style type='text/css'>html {overflow-x: initial !important;}:root { --bg-color:#ffffff; --text-color:#333333; --select-text-bg-color:#B5D6FC; --select-text-font-color:auto; --monospace:"Lucida Console",Consolas,"Courier",monospace; --title-bar-height:20px; }
.mac-os-11 { --title-bar-height:28px; }
html { font-size: 14px; background-color: var(--bg-color); color: var(--text-color); font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; -webkit-font-smoothing: antialiased; }
body { margin: 0px; padding: 0px; height: auto; inset: 0px; font-size: 1rem; line-height: 1.42857; overflow-x: hidden; background: inherit; tab-size: 4; }
iframe { margin: auto; }
a.url { word-break: break-all; }
a:active, a:hover { outline: 0px; }
.in-text-selection, ::selection { text-shadow: none; background: var(--select-text-bg-color); color: var(--select-text-font-color); }
#write { margin: 0px auto; height: auto; width: inherit; word-break: normal; overflow-wrap: break-word; position: relative; white-space: normal; overflow-x: visible; padding-top: 36px; }
#write.first-line-indent p { text-indent: 2em; }
#write.first-line-indent li p, #write.first-line-indent p * { text-indent: 0px; }
#write.first-line-indent li { margin-left: 2em; }
.for-image #write { padding-left: 8px; padding-right: 8px; }
body.typora-export { padding-left: 30px; padding-right: 30px; }
.typora-export .footnote-line, .typora-export li, .typora-export p { white-space: pre-wrap; }
.typora-export .task-list-item input { pointer-events: none; }
@media screen and (max-width: 500px) {
  body.typora-export { padding-left: 0px; padding-right: 0px; }
  #write { padding-left: 20px; padding-right: 20px; }
  .CodeMirror-sizer { margin-left: 0px !important; }
  .CodeMirror-gutters { display: none !important; }
}
#write li > figure:last-child { margin-bottom: 0.5rem; }
#write ol, #write ul { position: relative; }
img { max-width: 100%; vertical-align: middle; image-orientation: from-image; }
button, input, select, textarea { color: inherit; font: inherit; }
input[type="checkbox"], input[type="radio"] { line-height: normal; padding: 0px; }
*, ::after, ::before { box-sizing: border-box; }
#write h1, #write h2, #write h3, #write h4, #write h5, #write h6, #write p, #write pre { width: inherit; }
#write h1, #write h2, #write h3, #write h4, #write h5, #write h6, #write p { position: relative; }
p { line-height: inherit; }
h1, h2, h3, h4, h5, h6 { break-after: avoid-page; break-inside: avoid; orphans: 4; }
p { orphans: 4; }
h1 { font-size: 2rem; }
h2 { font-size: 1.8rem; }
h3 { font-size: 1.6rem; }
h4 { font-size: 1.4rem; }
h5 { font-size: 1.2rem; }
h6 { font-size: 1rem; }
.md-math-block, .md-rawblock, h1, h2, h3, h4, h5, h6, p { margin-top: 1rem; margin-bottom: 1rem; }
.hidden { display: none; }
.md-blockmeta { color: rgb(204, 204, 204); font-weight: 700; font-style: italic; }
a { cursor: pointer; }
sup.md-footnote { padding: 2px 4px; background-color: rgba(238, 238, 238, 0.7); color: rgb(85, 85, 85); border-radius: 4px; cursor: pointer; }
sup.md-footnote a, sup.md-footnote a:hover { color: inherit; text-transform: inherit; text-decoration: inherit; }
#write input[type="checkbox"] { cursor: pointer; width: inherit; height: inherit; }
figure { overflow-x: auto; margin: 1.2em 0px; max-width: calc(100% + 16px); padding: 0px; }
figure > table { margin: 0px; }
tr { break-inside: avoid; break-after: auto; }
thead { display: table-header-group; }
table { border-collapse: collapse; border-spacing: 0px; width: 100%; overflow: auto; break-inside: auto; text-align: left; }
table.md-table td { min-width: 32px; }
.CodeMirror-gutters { border-right: 0px; background-color: inherit; }
.CodeMirror-linenumber { user-select: none; }
.CodeMirror { text-align: left; }
.CodeMirror-placeholder { opacity: 0.3; }
.CodeMirror pre { padding: 0px 4px; }
.CodeMirror-lines { padding: 0px; }
div.hr:focus { cursor: none; }
#write pre { white-space: pre-wrap; }
#write.fences-no-line-wrapping pre { white-space: pre; }
#write pre.ty-contain-cm { white-space: normal; }
.CodeMirror-gutters { margin-right: 4px; }
.md-fences { font-size: 0.9rem; display: block; break-inside: avoid; text-align: left; overflow: visible; white-space: pre; background: inherit; position: relative !important; }
.md-fences-adv-panel { width: 100%; margin-top: 10px; text-align: center; padding-top: 0px; padding-bottom: 8px; overflow-x: auto; }
#write .md-fences.mock-cm { white-space: pre-wrap; }
.md-fences.md-fences-with-lineno { padding-left: 0px; }
#write.fences-no-line-wrapping .md-fences.mock-cm { white-space: pre; overflow-x: auto; }
.md-fences.mock-cm.md-fences-with-lineno { padding-left: 8px; }
.CodeMirror-line, twitterwidget { break-inside: avoid; }
.footnotes { opacity: 0.8; font-size: 0.9rem; margin-top: 1em; margin-bottom: 1em; }
.footnotes + .footnotes { margin-top: 0px; }
.md-reset { margin: 0px; padding: 0px; border: 0px; outline: 0px; vertical-align: top; background: 0px 0px; text-decoration: none; text-shadow: none; float: none; position: static; width: auto; height: auto; white-space: nowrap; cursor: inherit; -webkit-tap-highlight-color: transparent; line-height: normal; font-weight: 400; text-align: left; box-sizing: content-box; direction: ltr; }
li div { padding-top: 0px; }
blockquote { margin: 1rem 0px; }
li .mathjax-block, li p { margin: 0.5rem 0px; }
li blockquote { margin: 1rem 0px; }
li { margin: 0px; position: relative; }
blockquote > :last-child { margin-bottom: 0px; }
blockquote > :first-child, li > :first-child { margin-top: 0px; }
.footnotes-area { color: rgb(136, 136, 136); margin-top: 0.714rem; padding-bottom: 0.143rem; white-space: normal; }
#write .footnote-line { white-space: pre-wrap; }
@media print {
  body, html { border: 1px solid transparent; height: 99%; break-after: avoid; break-before: avoid; font-variant-ligatures: no-common-ligatures; }
  #write { margin-top: 0px; padding-top: 0px; border-color: transparent !important; }
  .typora-export * { -webkit-print-color-adjust: exact; }
  .typora-export #write { break-after: avoid; }
  .typora-export #write::after { height: 0px; }
  .is-mac table { break-inside: avoid; }
  .typora-export-show-outline .typora-export-sidebar { display: none; }
}
.footnote-line { margin-top: 0.714em; font-size: 0.7em; }
a img, img a { cursor: pointer; }
pre.md-meta-block { font-size: 0.8rem; min-height: 0.8rem; white-space: pre-wrap; background: rgb(204, 204, 204); display: block; overflow-x: hidden; }
p > .md-image:only-child:not(.md-img-error) img, p > img:only-child { display: block; margin: auto; }
#write.first-line-indent p > .md-image:only-child:not(.md-img-error) img { left: -2em; position: relative; }
p > .md-image:only-child { display: inline-block; width: 100%; }
#write .MathJax_Display { margin: 0.8em 0px 0px; }
.md-math-block { width: 100%; }
.md-math-block:not(:empty)::after { display: none; }
.MathJax_ref { fill: currentcolor; }
[contenteditable="true"]:active, [contenteditable="true"]:focus, [contenteditable="false"]:active, [contenteditable="false"]:focus { outline: 0px; box-shadow: none; }
.md-task-list-item { position: relative; list-style-type: none; }
.task-list-item.md-task-list-item { padding-left: 0px; }
.md-task-list-item > input { position: absolute; top: 0px; left: 0px; margin-left: -1.2em; margin-top: calc(1em - 10px); border: none; }
.math { font-size: 1rem; }
.md-toc { min-height: 3.58rem; position: relative; font-size: 0.9rem; border-radius: 10px; }
.md-toc-content { position: relative; margin-left: 0px; }
.md-toc-content::after, .md-toc::after { display: none; }
.md-toc-item { display: block; color: rgb(65, 131, 196); }
.md-toc-item a { text-decoration: none; }
.md-toc-inner:hover { text-decoration: underline; }
.md-toc-inner { display: inline-block; cursor: pointer; }
.md-toc-h1 .md-toc-inner { margin-left: 0px; font-weight: 700; }
.md-toc-h2 .md-toc-inner { margin-left: 2em; }
.md-toc-h3 .md-toc-inner { margin-left: 4em; }
.md-toc-h4 .md-toc-inner { margin-left: 6em; }
.md-toc-h5 .md-toc-inner { margin-left: 8em; }
.md-toc-h6 .md-toc-inner { margin-left: 10em; }
@media screen and (max-width: 48em) {
  .md-toc-h3 .md-toc-inner { margin-left: 3.5em; }
  .md-toc-h4 .md-toc-inner { margin-left: 5em; }
  .md-toc-h5 .md-toc-inner { margin-left: 6.5em; }
  .md-toc-h6 .md-toc-inner { margin-left: 8em; }
}
a.md-toc-inner { font-size: inherit; font-style: inherit; font-weight: inherit; line-height: inherit; }
.footnote-line a:not(.reversefootnote) { color: inherit; }
.md-attr { display: none; }
.md-fn-count::after { content: "."; }
code, pre, samp, tt { font-family: var(--monospace); }
kbd { margin: 0px 0.1em; padding: 0.1em 0.6em; font-size: 0.8em; color: rgb(36, 39, 41); background: rgb(255, 255, 255); border: 1px solid rgb(173, 179, 185); border-radius: 3px; box-shadow: rgba(12, 13, 14, 0.2) 0px 1px 0px, rgb(255, 255, 255) 0px 0px 0px 2px inset; white-space: nowrap; vertical-align: middle; }
.md-comment { color: rgb(162, 127, 3); opacity: 0.6; font-family: var(--monospace); }
code { text-align: left; vertical-align: initial; }
a.md-print-anchor { white-space: pre !important; border-width: initial !important; border-style: none !important; border-color: initial !important; display: inline-block !important; position: absolute !important; width: 1px !important; right: 0px !important; outline: 0px !important; background: 0px 0px !important; text-decoration: initial !important; text-shadow: initial !important; }
.os-windows.monocolor-emoji .md-emoji { font-family: "Segoe UI Symbol", sans-serif; }
.md-diagram-panel > svg { max-width: 100%; }
[lang="flow"] svg, [lang="mermaid"] svg { max-width: 100%; height: auto; }
[lang="mermaid"] .node text { font-size: 1rem; }
table tr th { border-bottom: 0px; }
video { max-width: 100%; display: block; margin: 0px auto; }
iframe { max-width: 100%; width: 100%; border: none; }
.highlight td, .highlight tr { border: 0px; }
mark { background: rgb(255, 255, 0); color: rgb(0, 0, 0); }
.md-html-inline .md-plain, .md-html-inline strong, mark .md-inline-math, mark strong { color: inherit; }
.md-expand mark .md-meta { opacity: 0.3 !important; }
mark .md-meta { color: rgb(0, 0, 0); }
@media print {
  .typora-export h1, .typora-export h2, .typora-export h3, .typora-export h4, .typora-export h5, .typora-export h6 { break-inside: avoid; }
}
.md-diagram-panel .messageText { stroke: none !important; }
.md-diagram-panel .start-state { fill: var(--node-fill); }
.md-diagram-panel .edgeLabel rect { opacity: 1 !important; }
.md-fences.md-fences-math { font-size: 1em; }
.md-fences-advanced:not(.md-focus) { padding: 0px; white-space: nowrap; border: 0px; }
.md-fences-advanced:not(.md-focus) { background: inherit; }
.typora-export-show-outline .typora-export-content { max-width: 1440px; margin: auto; display: flex; flex-direction: row; }
.typora-export-sidebar { width: 300px; font-size: 0.8rem; margin-top: 80px; margin-right: 18px; }
.typora-export-show-outline #write { --webkit-flex:2; flex: 2 1 0%; }
.typora-export-sidebar .outline-content { position: fixed; top: 0px; max-height: 100%; overflow: hidden auto; padding-bottom: 30px; padding-top: 60px; width: 300px; }
@media screen and (max-width: 1024px) {
  .typora-export-sidebar, .typora-export-sidebar .outline-content { width: 240px; }
}
@media screen and (max-width: 800px) {
  .typora-export-sidebar { display: none; }
}
.outline-content li, .outline-content ul { margin-left: 0px; margin-right: 0px; padding-left: 0px; padding-right: 0px; list-style: none; }
.outline-content ul { margin-top: 0px; margin-bottom: 0px; }
.outline-content strong { font-weight: 400; }
.outline-expander { width: 1rem; height: 1.42857rem; position: relative; display: table-cell; vertical-align: middle; cursor: pointer; padding-left: 4px; }
.outline-expander::before { content: ""; position: relative; font-family: Ionicons; display: inline-block; font-size: 8px; vertical-align: middle; }
.outline-item { padding-top: 3px; padding-bottom: 3px; cursor: pointer; }
.outline-expander:hover::before { content: ""; }
.outline-h1 > .outline-item { padding-left: 0px; }
.outline-h2 > .outline-item { padding-left: 1em; }
.outline-h3 > .outline-item { padding-left: 2em; }
.outline-h4 > .outline-item { padding-left: 3em; }
.outline-h5 > .outline-item { padding-left: 4em; }
.outline-h6 > .outline-item { padding-left: 5em; }
.outline-label { cursor: pointer; display: table-cell; vertical-align: middle; text-decoration: none; color: inherit; }
.outline-label:hover { text-decoration: underline; }
.outline-item:hover { border-color: rgb(245, 245, 245); background-color: var(--item-hover-bg-color); }
.outline-item:hover { margin-left: -28px; margin-right: -28px; border-left: 28px solid transparent; border-right: 28px solid transparent; }
.outline-item-single .outline-expander::before, .outline-item-single .outline-expander:hover::before { display: none; }
.outline-item-open > .outline-item > .outline-expander::before { content: ""; }
.outline-children { display: none; }
.info-panel-tab-wrapper { display: none; }
.outline-item-open > .outline-children { display: block; }
.typora-export .outline-item { padding-top: 1px; padding-bottom: 1px; }
.typora-export .outline-item:hover { margin-right: -8px; border-right: 8px solid transparent; }
.typora-export .outline-expander::before { content: "+"; font-family: inherit; top: -1px; }
.typora-export .outline-expander:hover::before, .typora-export .outline-item-open > .outline-item > .outline-expander::before { content: "−"; }
.typora-export-collapse-outline .outline-children { display: none; }
.typora-export-collapse-outline .outline-item-open > .outline-children, .typora-export-no-collapse-outline .outline-children { display: block; }
.typora-export-no-collapse-outline .outline-expander::before { content: "" !important; }
.typora-export-show-outline .outline-item-active > .outline-item .outline-label { font-weight: 700; }
.md-inline-math-container mjx-container { zoom: 0.95; }


.CodeMirror { height: auto; }
.CodeMirror.cm-s-inner { background: inherit; }
.CodeMirror-scroll { overflow: auto hidden; z-index: 3; }
.CodeMirror-gutter-filler, .CodeMirror-scrollbar-filler { background-color: rgb(255, 255, 255); }
.CodeMirror-gutters { border-right: 1px solid rgb(221, 221, 221); background: inherit; white-space: nowrap; }
.CodeMirror-linenumber { padding: 0px 3px 0px 5px; text-align: right; color: rgb(153, 153, 153); }
.cm-s-inner .cm-keyword { color: rgb(119, 0, 136); }
.cm-s-inner .cm-atom, .cm-s-inner.cm-atom { color: rgb(34, 17, 153); }
.cm-s-inner .cm-number { color: rgb(17, 102, 68); }
.cm-s-inner .cm-def { color: rgb(0, 0, 255); }
.cm-s-inner .cm-variable { color: rgb(0, 0, 0); }
.cm-s-inner .cm-variable-2 { color: rgb(0, 85, 170); }
.cm-s-inner .cm-variable-3 { color: rgb(0, 136, 85); }
.cm-s-inner .cm-string { color: rgb(170, 17, 17); }
.cm-s-inner .cm-property { color: rgb(0, 0, 0); }
.cm-s-inner .cm-operator { color: rgb(152, 26, 26); }
.cm-s-inner .cm-comment, .cm-s-inner.cm-comment { color: rgb(170, 85, 0); }
.cm-s-inner .cm-string-2 { color: rgb(255, 85, 0); }
.cm-s-inner .cm-meta { color: rgb(85, 85, 85); }
.cm-s-inner .cm-qualifier { color: rgb(85, 85, 85); }
.cm-s-inner .cm-builtin { color: rgb(51, 0, 170); }
.cm-s-inner .cm-bracket { color: rgb(153, 153, 119); }
.cm-s-inner .cm-tag { color: rgb(17, 119, 0); }
.cm-s-inner .cm-attribute { color: rgb(0, 0, 204); }
.cm-s-inner .cm-header, .cm-s-inner.cm-header { color: rgb(0, 0, 255); }
.cm-s-inner .cm-quote, .cm-s-inner.cm-quote { color: rgb(0, 153, 0); }
.cm-s-inner .cm-hr, .cm-s-inner.cm-hr { color: rgb(153, 153, 153); }
.cm-s-inner .cm-link, .cm-s-inner.cm-link { color: rgb(0, 0, 204); }
.cm-negative { color: rgb(221, 68, 68); }
.cm-positive { color: rgb(34, 153, 34); }
.cm-header, .cm-strong { font-weight: 700; }
.cm-del { text-decoration: line-through; }
.cm-em { font-style: italic; }
.cm-link { text-decoration: underline; }
.cm-error { color: red; }
.cm-invalidchar { color: red; }
.cm-constant { color: rgb(38, 139, 210); }
.cm-defined { color: rgb(181, 137, 0); }
div.CodeMirror span.CodeMirror-matchingbracket { color: rgb(0, 255, 0); }
div.CodeMirror span.CodeMirror-nonmatchingbracket { color: rgb(255, 34, 34); }
.cm-s-inner .CodeMirror-activeline-background { background: inherit; }
.CodeMirror { position: relative; overflow: hidden; }
.CodeMirror-scroll { height: 100%; outline: 0px; position: relative; box-sizing: content-box; background: inherit; }
.CodeMirror-sizer { position: relative; }
.CodeMirror-gutter-filler, .CodeMirror-hscrollbar, .CodeMirror-scrollbar-filler, .CodeMirror-vscrollbar { position: absolute; z-index: 6; display: none; outline: 0px; }
.CodeMirror-vscrollbar { right: 0px; top: 0px; overflow: hidden; }
.CodeMirror-hscrollbar { bottom: 0px; left: 0px; overflow: auto hidden; }
.CodeMirror-scrollbar-filler { right: 0px; bottom: 0px; }
.CodeMirror-gutter-filler { left: 0px; bottom: 0px; }
.CodeMirror-gutters { position: absolute; left: 0px; top: 0px; padding-bottom: 10px; z-index: 3; overflow-y: hidden; }
.CodeMirror-gutter { white-space: normal; height: 100%; box-sizing: content-box; padding-bottom: 30px; margin-bottom: -32px; display: inline-block; }
.CodeMirror-gutter-wrapper { position: absolute; z-index: 4; background: 0px 0px !important; border: none !important; }
.CodeMirror-gutter-background { position: absolute; top: 0px; bottom: 0px; z-index: 4; }
.CodeMirror-gutter-elt { position: absolute; cursor: default; z-index: 4; }
.CodeMirror-lines { cursor: text; }
.CodeMirror pre { border-radius: 0px; border-width: 0px; background: 0px 0px; font-family: inherit; font-size: inherit; margin: 0px; white-space: pre; overflow-wrap: normal; color: inherit; z-index: 2; position: relative; overflow: visible; }
.CodeMirror-wrap pre { overflow-wrap: break-word; white-space: pre-wrap; word-break: normal; }
.CodeMirror-code pre { border-right: 30px solid transparent; width: fit-content; }
.CodeMirror-wrap .CodeMirror-code pre { border-right: none; width: auto; }
.CodeMirror-linebackground { position: absolute; inset: 0px; z-index: 0; }
.CodeMirror-linewidget { position: relative; z-index: 2; overflow: auto; }
.CodeMirror-wrap .CodeMirror-scroll { overflow-x: hidden; }
.CodeMirror-measure { position: absolute; width: 100%; height: 0px; overflow: hidden; visibility: hidden; }
.CodeMirror-measure pre { position: static; }
.CodeMirror div.CodeMirror-cursor { position: absolute; visibility: hidden; border-right: none; width: 0px; }
.CodeMirror div.CodeMirror-cursor { visibility: hidden; }
.CodeMirror-focused div.CodeMirror-cursor { visibility: inherit; }
.cm-searching { background: rgba(255, 255, 0, 0.4); }
span.cm-underlined { text-decoration: underline; }
span.cm-strikethrough { text-decoration: line-through; }
.cm-tw-syntaxerror { color: rgb(255, 255, 255); background-color: rgb(153, 0, 0); }
.cm-tw-deleted { text-decoration: line-through; }
.cm-tw-header5 { font-weight: 700; }
.cm-tw-listitem:first-child { padding-left: 10px; }
.cm-tw-box { border-style: solid; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-color: inherit; border-top-width: 0px !important; }
.cm-tw-underline { text-decoration: underline; }
@media print {
  .CodeMirror div.CodeMirror-cursor { visibility: hidden; }
}


html {
	font-size: 19px;
}

html, body {
	margin: auto;
	background: #fefefe;
	-webkit-font-smoothing: antialiased;
}
body {
	font-family: "Vollkorn", Palatino, Times;
	color: #333;
	line-height: 1.4;
	text-align: justify;
}

#write {
	max-width: 960px;
	margin: 0 auto;
	margin-bottom: 2em;
	line-height: 1.53;
	padding-top: 40px;
}

@media only screen and (min-width: 1400px) {
	#write {
		max-width: 1100px;
	}
}

@media print {
	html {
		font-size: 13px;
	}
}

/* Typography
-------------------------------------------------------- */

#write>h1:first-child,
h1 {
	margin-top: 1.6em;
	font-weight: normal;
}

h1 {
	font-size:3em;
}

h2 {
	margin-top:2em;
	font-weight: normal;
}

h3 {
	font-weight: normal;
	font-style: italic;
	margin-top: 3em;
}

h1, 
h2, 
h3{
	text-align: center;
}

h2:after{
	border-bottom: 1px solid #2f2f2f;
    content: '';
    width: 100px;
    display: block;
    margin: 0 auto;
    height: 1px;
}

h1+h2, h2+h3 {
	margin-top: 0.83em;
}

p,
.mathjax-block {
	margin-top: 0;
	-webkit-hypens: auto;
	-moz-hypens: auto;
	hyphens: auto;
}
ul {
	list-style: square;
	padding-left: 1.2em;
}
ol {
	padding-left: 1.2em;
}
blockquote {
	margin-left: 1em;
	padding-left: 1em;
	border-left: 1px solid #ddd;
}
code,
pre {
	font-family: "Consolas", "Menlo", "Monaco", monospace, serif;
	font-size: .9em;
	background: white;
}
.md-fences{
	margin-left: 1em;
	padding-left: 1em;
	border: 1px solid #ddd;
	padding-bottom: 8px;
	padding-top: 6px;
	margin-bottom: 1.5em;
}

a {
	color: #2484c1;
	text-decoration: none;
}
a:hover {
	text-decoration: underline;
}
a img {
	border: none;
}
h1 a,
h1 a:hover {
	color: #333;
	text-decoration: none;
}
hr {
	color: #ddd;
	height: 1px;
	margin: 2em 0;
	border-top: solid 1px #ddd;
	border-bottom: none;
	border-left: 0;
	border-right: 0;
}
.ty-table-edit {
	background: #ededed;
    padding-top: 4px;
}
table {
	margin-bottom: 1.333333rem
}
table th,
table td {
	padding: 8px;
	line-height: 1.333333rem;
	vertical-align: top;
	border-top: 1px solid #ddd
}
table th {
	font-weight: bold
}
table thead th {
	vertical-align: bottom
}
table caption+thead tr:first-child th,
table caption+thead tr:first-child td,
table colgroup+thead tr:first-child th,
table colgroup+thead tr:first-child td,
table thead:first-child tr:first-child th,
table thead:first-child tr:first-child td {
	border-top: 0
}
table tbody+tbody {
	border-top: 2px solid #ddd
}

.task-list{
	padding:0;
}

.md-task-list-item {
	padding-left: 1.6rem;
}

.md-task-list-item > input:before {
	content: '\221A';
	display: inline-block;
	width: 1.33333333rem;
  	height: 1.6rem;
	vertical-align: middle;
	text-align: center;
	color: #ddd;
	background-color: #fefefe;
}

.md-task-list-item > input:checked:before,
.md-task-list-item > input[checked]:before{
	color: inherit;
}
.md-tag {
	color: inherit;
	font: inherit;
}
#write pre.md-meta-block {
	min-height: 35px;
	padding: 0.5em 1em;
}
#write pre.md-meta-block {
	white-space: pre;
	background: #f8f8f8;
	border: 0px;
	color: #999;
	
	width: 100vw;
	max-width: calc(100% + 60px);
	margin-left: -30px;
	border-left: 30px #f8f8f8 solid;
	border-right: 30px #f8f8f8 solid;

	margin-bottom: 2em;
	margin-top: -1.3333333333333rem;
	padding-top: 26px;
	padding-bottom: 10px;
	line-height: 1.8em;
	font-size: 0.9em;
	font-size: 0.76em;
	padding-left: 0;
}
.md-img-error.md-image>.md-meta{
	vertical-align: bottom;
}
#write>h5.md-focus:before {
	top: 2px;
}

.md-toc {
	margin-top: 40px;
}

.md-toc-content {
	padding-bottom: 20px;
}

.outline-expander:before {
	color: inherit;
	font-size: 14px;
	top: auto;
	content: "\f0da";
	font-family: FontAwesome;
}

.outline-expander:hover:before,
.outline-item-open>.outline-item>.outline-expander:before {
  	content: "\f0d7";
}

/** source code mode */
#typora-source {
	font-family: Courier, monospace;
    color: #6A6A6A;
}

.html-for-mac #typora-sidebar {
    -webkit-box-shadow: 0 6px 12px rgba(0, 0, 0, .175);
    box-shadow: 0 6px 12px rgba(0, 0, 0, .175);
}

.cm-s-typora-default .cm-header, 
.cm-s-typora-default .cm-property,
.CodeMirror.cm-s-typora-default div.CodeMirror-cursor {
	color: #428bca;
}

.cm-s-typora-default .cm-atom, .cm-s-typora-default .cm-number {
	color: #777777;
}

.typora-node .file-list-item-parent-loc, 
.typora-node .file-list-item-time, 
.typora-node .file-list-item-summary {
	font-family: arial, sans-serif;
}

.md-task-list-item>input {
    margin-left: -1.3em;
    margin-top: calc(1rem - 12px);
}

.md-mathjax-midline {
	background: #fafafa;
}

.md-fences .code-tooltip {
	bottom: -2em !important;
}

.dropdown-menu .divider {
	border-color: #e5e5e5;
}


mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
  min-height: 1px;
  min-width: 1px;
}

mjx-container[jax="SVG"] > svg a {
  fill: blue;
  stroke: blue;
}

mjx-assistive-mml {
  position: absolute !important;
  top: 0px;
  left: 0px;
  clip: rect(1px, 1px, 1px, 1px);
  padding: 1px 0px 0px 0px !important;
  border: 0px !important;
  display: block !important;
  width: auto !important;
  overflow: hidden !important;
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  -khtml-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

mjx-assistive-mml[display="block"] {
  width: 100% !important;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][display="true"][width="full"] {
  display: flex;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line], svg[data-table] > g > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame], svg[data-table] > g > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed, svg[data-table] > g > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted, svg[data-table] > g > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > g > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

mjx-container[jax="SVG"] path[data-c], mjx-container[jax="SVG"] use[data-c] {
  stroke-width: 3;
}

g[data-mml-node="xypic"] path {
  stroke-width: inherit;
}

.MathJax g[data-mml-node="xypic"] path {
  stroke-width: inherit;
}
mjx-container[jax="SVG"] path[data-c], mjx-container[jax="SVG"] use[data-c] {
							stroke-width: 0;
						}
</style><title></title>
</head>
<body class='typora-export os-windows'><div class='typora-export-content'>
<div id='write'  class=''><h1 id='raft算法复盘笔记20230710）'><span>Raft算法复盘笔记（20230710）</span></h1><div class='md-toc' mdtype='toc'><p class="md-toc-content" role="list"><span role="listitem" class="md-toc-item md-toc-h1" data-ref="n0"><a class="md-toc-inner" href="#raft算法复盘笔记20230710）">Raft算法复盘笔记（20230710）</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n814"><a class="md-toc-inner" href="#0-raft算法与分布式kv存储算法的关系">0 Raft算法与分布式KV存储算法的关系</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n24"><a class="md-toc-inner" href="#1-论文部分总结">1 论文部分总结</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n273"><a class="md-toc-inner" href="#11-论文基础铺垫">1.1 论文基础铺垫</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n31"><a class="md-toc-inner" href="#111--共识算法概念">1.1.1  共识算法概念</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n37"><a class="md-toc-inner" href="#112-raft算法概念">1.1.2 Raft算法概念</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n76"><a class="md-toc-inner" href="#112-raft算法的优势">1.1.2 Raft算法的优势</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n116"><a class="md-toc-inner" href="#112-复制状态机">1.1.2 复制状态机</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n221"><a class="md-toc-inner" href="#112-paxos算法的问题">1.1.2 Paxos算法的问题</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n239"><a class="md-toc-inner" href="#116-为可理解而设计-raft算法">1.1.6 为可理解而设计-Raft算法</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n272"><a class="md-toc-inner" href="#12-raft算法核心">1.2 Raft算法核心</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n290"><a class="md-toc-inner" href="#121-三个核心问题">1.2.1 三个核心问题</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n308"><a class="md-toc-inner" href="#122-raft共识算法一些约定">1.2.2 Raft共识算法一些约定</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n312"><a class="md-toc-inner" href="#123-raft算法基础">1.2.3 Raft算法基础</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n593"><a class="md-toc-inner" href="#124-leader选举">1.2.4 Leader选举</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n673"><a class="md-toc-inner" href="#125-日志复制">1.2.5 日志复制</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n807"><a class="md-toc-inner" href="#2加深理解的文章">2、加深理解的文章</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n824"><a class="md-toc-inner" href="#21-编写前的-raft-理论基础">2.1 编写前的 Raft 理论基础</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n848"><a class="md-toc-inner" href="#22-实现步骤">2.2 实现步骤</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n868"><a class="md-toc-inner" href="#23-技术选型">2.3 技术选型</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1723"><a class="md-toc-inner" href="#24-动画演示">2.4 动画演示</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n822"><a class="md-toc-inner" href="#3代码复盘">3、代码复盘</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n808"><a class="md-toc-inner" href="#21-sofa-bolt框架介绍">2.1 SOFA-BOlt框架介绍</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n1741"><a class="md-toc-inner" href="#211-功能介绍">2.1.1 功能介绍</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1809"><a class="md-toc-inner" href="#22-rocksdb框架介绍">2.2 RocksDB框架介绍</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1836"><a class="md-toc-inner" href="#23-代码结合论文理解">2.3 代码结合论文理解</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n1837"><a class="md-toc-inner" href="#231-rpc实现">2.3.1 RPC实现</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n1849"><a class="md-toc-inner" href="#232-用户端实现">2.3.2 用户端实现</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n1910"><a class="md-toc-inner" href="#233-节点端实现">2.3.3 节点端实现</a></span></p></div><p><font color='orange'><span>技术栈：</span></font></p><p><font color='red'><span>Slf4j</span></font><span>：日志框架</span></p><p><font color='red'><span>Lombok </span></font><span>：@Setter @Getter</span></p><p><font color='red'><span>JUC并发包</span></font><span>：包括但不限于原子类，Future，CountDownLatch，用来控制并发和安全性</span></p><p><font color='red'><span>Jedis</span></font><span>：用于实现状态机，存放状态机的日志，在项目中主要还是采用rcoksDB，而不是Jedis。</span></p><p><font color='red'><span>rocksDB</span></font><span>：用于存放状态机的日志</span></p><p><font color='red'><span>SOFA-Bolt（基于Netty）</span></font><span>：用于不同节点之间的RPC通信</span></p><p><font color='red'><span>线程池</span></font><span>：降低线程创建和管理的开销</span></p><h2 id='0-raft算法与分布式kv存储算法的关系'><span>0 Raft算法与分布式KV存储算法的关系</span></h2><p><span>		</span><span>Raft算法本身并不是一个专门用于分布式KV存储的算法，而是一种分布式共识算法，用于在分布式系统中达成一致性并维护复制状态机。然而，Raft算法可以被应用于构建分布式KV存储系统。</span></p><p><span>		</span><span>在分布式KV存储系统中，多个节点协作工作，存储键值对数据并提供读写操作。为了确保数据的一致性和可靠性，需要使用共识算法来处理节点之间的数据复制和一致性维护。Raft算法正是一种常用的共识算法之一，可以用于构建具有高可用性和容错性的分布式KV存储系统。</span></p><p><span>		</span><span>在基于Raft算法的分布式KV存储系统中，节点可以按照Raft算法的角色（领导者、跟随者、候选者）进行工作，并通过Raft算法的选举和日志复制机制来实现数据的一致性和持久性。每个节点都维护自己的状态机，根据接收到的日志条目来更新自身状态和数据。通过Raft算法的保证，节点之间可以达成一致的数据视图，并提供强一致性的读写操作。</span></p><p><span>		</span><span>需要注意的是，Raft算法仅提供了一种共识算法的框架，具体的分布式KV存储系统的实现可能还涉及其他组件和功能，如数据分片、故障恢复、负载均衡等。因此，Raft算法在实际应用中通常与其他技术和算法结合使用，以构建完整的分布式KV存储系统。</span></p><h2 id='1-论文部分总结'><span>1 论文部分总结</span></h2><h3 id='11-论文基础铺垫'><span>1.1 论文基础铺垫</span></h3><p><span>Raft为了增强可理解性，将共识算法的关键要素（如领导人选举、日志复制和安全性）分离出来，并强制执行更强的一致性以减少必须考虑的状态数量。</span></p><p><span>Raft还包括一种用于</span><strong><span>更改集群成员资格的新机制，该机制使用重叠多数来保证安全。</span></strong></p><h4 id='111--共识算法概念'><span>1.1.1  共识算法概念</span></h4><p><span>		</span><span>共识算法允许一组机器作为一个</span><strong><span>状态一致</span></strong><span>的组工作，可以在其某些成员出现故障时幸存下来。 正因为如此，它们在构建可靠的大型软件系统方面发挥着关键作用。</span></p><p><span>		</span><font color='red'><span>共识算法是一种用于在分布式系统中达成一致性的算法。在分布式系统中，多个节点（或者称为进程）通过互相通信来协调它们的行为以达成共识，即就某个值、顺序或状态达成一致。</span></font></p><p><span>		</span><span>在分布式系统中，</span><font color='orange'><span>由于网络延迟、节点故障等原因</span></font><span>，节点之间可能会出现不一致的状态。</span><font color='orange'><span>共识算法的目标是确保系统中的各个节点就某个问题达成一致，即使在存在故障的情况下也能保持一致性。</span></font></p><p><span>		</span><span>共识算法通常涉及到一个或多个节点被选举为领导者（或主节点），</span><font color='orange'><span>领导者负责提出某个值或决策，并将其通知给其他节点。其他节点将接受领导者的提议，并对其进行投票或反馈。一旦足够多的节点接受了领导者的提议，达到了一定的条件，共识算法就认为达成了共识，即节点达到了一致的状态。</span></font></p><p><strong><span>一些常见的共识算法包括：</span></strong></p><ol start='' ><li><span>Paxos：Paxos是一种经典的共识算法，它通过多轮的消息交互来达成共识。它包括角色如提议者、接受者和学习者，并通过投票和阶段性的决策来实现共识。</span></li><li><span>Raft：Raft算法是一种相对较新的共识算法，它将共识问题分解为领导者选举、日志复制和安全性等几个关键问题，并提供了一种模块化的解决方案。Raft算法的设计目标是简单易懂和可维护。</span></li><li><span>Practical Byzantine Fault Tolerance (PBFT)：PBFT是一种针对拜占庭容错的共识算法，可以容忍一部分节点的恶意行为。它通过互相交换消息和多轮的投票来达成共识，并提供了强一致性保证。</span></li></ol><p><span>这些共识算法都有不同的特点和适用场景，选择适合的算法需要根据具体的系统需求和性能要求进行综合考虑。</span></p><h4 id='112-raft算法概念'><span>1.1.2 Raft算法概念</span></h4><p><span>		</span><span>在设计 Raft 时，我们应用了特定的技术来提高可理解性，包括</span><strong><span>分解（Raft将领导者选举、日志复制和安全性分开）</span></strong><span>和状态空间缩减（相对于 Paxos，Raft 降低了不确定性程度和减少了服务器之间可能不一致的方式）</span></p><p><span>Raft 在很多方面与现有的共识算法相似（最著名的是 Oki 和 Liskov 的 Viewstamped Replication），</span><strong><span>但它有几个新颖的特性：</span></strong></p><ul><li><span>强领导者：Raft 使用比其他共识算法更强的领导人形式。 例如，日志条目仅从领导者流向其他服务器。 这简化了复制日志的管理，并使 Raft 更容易理解。</span></li><li><span>领导者选举：Raft 使用</span><strong><span>随机定时器</span></strong><span>来选举领导者。 这只为任何共识算法已经需要的心跳增加了少量机制，同时简单快速地解决了冲突。（不同的节点随机发出想成为Leader的信息）</span></li><li><span>成员变更：Raft 用于变更集群中服务器集合的机制使用了一种新的联合共识方法，其中两种不同配置的大多数在转换期间重叠。 这允许集群在配置更改期间继续正常运行。</span></li></ul><h4 id='112-raft算法的优势'><span>1.1.2 Raft算法的优势</span></h4><p><span>		</span><span>Raft 比 Paxos 和其他共识算法更胜一筹，无论是出于教育目的还是作为代码实现的基础。它比其他算法更简单，更容易理解；它的描述足够完整，可以满足</span>
<span>实际系统的需要；它有几个开源的实现，并被几个公司使用；它的安全属性已经被正式规定和证明；它的效率与其他算法相当。</span></p><p><strong><span>Raft算法是一种用于分布式一致性的共识算法，与一些已有的算法相比，它具有以下优势：</span></strong></p><p><font color='orange'><span>简单易懂</span></font><span>：Raft算法的设计目标之一是易于理解和实现。相比于一些复杂的共识算法如Paxos，Raft的算法逻辑更加清晰，概念上更容易理解，使得开发者能够更快地上手并正确地实现。</span></p><p><font color='orange'><span>容易调试和维护</span></font><span>：Raft算法的模块化设计使得系统的各个部分可以独立地进行测试和调试。它将共识算法拆分为几个关键的角色（领导者、跟随者和候选者），并定义了明确的状态转换规则，使得故障排查和修复变得更加容易。</span></p><p><font color='orange'><span>强一致性保证</span></font><span>：Raft算法提供强一致性保证，确保在分布式系统中的各个节点之间达成一致的状态。</span><strong><span>这意味着当一个值被提交并应用到系统中的某个节点上时，所有节点都会达到相同的状态。这种强一致性保证对于许多分布式应用来说是至关重要的。</span></strong></p><p><font color='orange'><span>选举机制高效稳定</span></font><span>：Raft算法通过定期选举领导者的方式来实现共识。相比于其他算法，如Paxos的多轮消息交互，Raft算法的选举过程更加高效。当领导者失效或无法联系时，Raft算法能够迅速选举出新的领导者，保持系统的可用性。</span></p><p><font color='orange'><span>可扩展性</span></font><span>：Raft算法的设计允许系统在需要时进行水平扩展。通过增加更多的节点，系统可以处理更大规模的工作负载，而且这可以在不影响现有节点的情况下进行。这种可扩展性是对于大规模分布式系统的需求。</span></p><p><strong><span>需要注意的是，Raft算法并非适用于所有分布式系统的最佳选择。根据具体的应用场景和需求，其他算法如Paxos或其他基于共识的算法也可能更加适合。因此，在选择适合的算法时，需要综合考虑系统的要求、可行性和性能等因素。</span></strong></p><h4 id='112-复制状态机'><span>1.1.2 复制状态机</span></h4><p><span>		</span><span>共识算法通常出现在复制状态机的上下文中。一组服务器上的状态机计算相同状态的相同副本，并且即使某些服务器关闭也可以继续运行。</span><strong><span>复制状态机用于解决分布式系统中的各种容错问题。</span></strong></p><p><span>		</span><span>复制状态机通常</span><strong><span>使用复制日志</span></strong><span>实现。每个日志</span><strong><span>包含相同顺序的相同命令</span></strong><span>，因此每个状态机处理相同的命令序列。</span><strong><span>由于状态机是确定性的，因此每个状态机</span></strong>
<strong><span>都计算相同的状态和相同的输出序列。</span></strong></p><p><img src="C:\Users\Waitfou\AppData\Roaming\Typora\typora-user-images\image-20230710154537705.png" referrerpolicy="no-referrer" alt="image-20230710154537705"></p><p><span>                                                                                                         </span><strong><span>Figure 1: 复制状态机架构。</span></strong></p><p><strong><span>共识算法管理一个复制日志，其中包含来自客户端的状态机命令。 所有状态机处理来自日志的相同命令序列，因此它们产生相同的输出。</span></strong></p><p><span>		</span><span>保持</span><strong><span>复制日志的一致性</span></strong><span>是共识算法的工作。</span><strong><span>服务器上的共识模块接收来自客户端的命令并将它们添加到其日志中。它与其他服务器上的共识模块通信，以确保每个日志最终都以相同的顺序包含相同的请求，即使某些服务器出现故障也是如此。</span></strong></p><p><span>		</span><strong><span>一旦正确复制了命令，每个服务器的状态机就会按日志顺序处理它们，并将输出返回给客户端。因此，这组服务器似乎形成了一个单一的、高度可靠的状态机。</span></strong></p><p><strong><span>实际系统的共识算法通常具有以下属性：</span></strong></p><ul><li><span>它们在所有非拜占庭条件下确保安全（永远不会返回错误的结果），包括</span><strong><span>网络延迟、分区和数据包丢失、重复和重新排序。</span></strong></li><li><span>只要任何大多数服务器都可以运行</span><strong><span>并且可以相互通信以及与客户端通信</span></strong><span>，它们就可以完全发挥作用（可用）。 </span><strong><span>因此，典型的五台服务器集群可以容忍任意两台服务器发生故障。</span></strong><span>假设服务器因停止而失败； 他们稍后可能会从稳定存储上的状态恢复并重新加入集群。</span></li><li><span>它们不依赖于时间来确保日志的一致性：</span><strong><span>错误的时钟和极端的消息延迟在最坏的情况下会导致可用性问题。</span></strong></li><li><span>在通常情况下，一旦集群中的大多数响应了单轮远程过程调用，命令就可以完成； 少数慢速服务器不会影响整体系统性能。</span></li></ul><p><font color='red'><span>状态机和服务器节点的区别：</span></font></p><p><span>在Raft算法中，状态机（state machine）和服务器节点（server node）是两个不同的概念。</span></p><ol start='' ><li><span>状态机（State Machine）：状态机是一种抽象概念，表示一个计算模型，它接受一系列输入并根据当前状态进行计算或操作，产生相应的输出或状态转换。在Raft算法中，每个服务器节点都包含一个状态机，用于执行应用程序的操作和逻辑。状态机可以看作是应用程序的抽象表示，它在Raft算法中作为一个黑盒子，用于表示应用程序的行为。</span></li><li><span>服务器节点（Server Node）：服务器节点是指参与Raft算法的实际节点，也称为Raft节点。每个服务器节点通过相互通信和协调来实现共识和一致性。服务器节点之间进行消息交换，包括选举领导者、复制日志等操作。每个服务器节点都具有状态（如领导者、跟随者或候选者），并维护自己的日志、任期和其他状态信息。</span></li></ol><p><span>在Raft算法中，多个服务器节点共同组成一个集群，并共同协作以达到共识。每个服务器节点都具有自己的状态机，用于执行应用程序的操作。节点之间通过交换消息和日志条目来达成共识，并保持日志的一致性。通过保持状态机的一致性，Raft算法确保在所有服务器节点上应用相同的日志序列，从而达到系统的一致性。</span></p><p><span>简而言之，状态机是一个抽象的计算模型，用于执行应用程序的操作和逻辑；服务器节点是实际参与Raft算法的节点，负责共识和状态同步。每个服务器节点都包含一个状态机，用于执行应用程序的操作。</span></p><h4 id='112-paxos算法的问题'><span>1.1.2 Paxos算法的问题</span></h4><p><span>Paxos首先定义了一个能够就单个决策达成一致的协议，例如单个复制的日志条目。我们将这个子集称为单指令PaxosPaxos然后将这个协议的多个实例结合起来，以促进一系列的决策，例如一（multiPaxos）个日志</span></p><p><strong><span>Paxos有两个明显的缺点。</span></strong><span> 第一个缺点是Paxos异常难以理解。 众所周知，完整的解释是不透明的； 很少有人能成功地理解它，而且只有付出巨大的努力。 因此，已经有几次尝试用更简单的术Paxos语来解释。</span></p><p><strong><span>Paxos的第二个问题</span></strong><span>是它没有为构建实际实现提供良好的基础。</span></p><p><span>此外。</span><strong><span>Paxos架构对于构建实用系统来说是一个糟糕的架构；</span></strong><span> 这是单一指令分解的另一个结果。 例如，独立地选择一组日志条目然后将它们合并成一个顺序日志几乎没有什么好处；这只会增加复杂性。 围绕日志设计系统更简单、更有效，其中新条目以受限顺序依次附加。 另一个问题是Paxos 在其核心使用对称的点对点方法（尽管它最终建议使用弱领导形式作为性能优化）。</span></p><p><font color='orange'><span>“Paxos算法的描述与实际系统的需求之间…..存在显着差距。最终系统将基于未经证实的协议”</span></font></p><h4 id='116-为可理解而设计-raft算法'><span>1.1.6 为可理解而设计-Raft算法</span></h4><p><span>		</span><span>它必须为系统构建提供一个完整且实用的基础。从而大大减少开发人员的设计工作量； 它必须在所有条件下都是安全的，并且在典型的操作条件下可用； 并且它必须对常见操作有效。但我们最重要的目标。也是最困难的挑是可理解性。</span></p><p><span>		</span><span>我们认识到此类分析具有高度的主观性；尽管如此，我们还是使用了两种普遍适用的技术。 第一种技术是众所周知的问题分解方法：只要有可能，我们就将问题分成单独的部分，这些部分可以相对独立地解决、解释和理解。 例如，在Raft中，我们将领导选举、日志复制、安全和成员变更分开。</span></p><p><span>		</span><span>我们的第二种方法是通过减少要考虑的状态数量来简化状态空间，使系统更加连贯并尽可能消除不确定性。具体来说，日志不允许有空洞，并且Raft限制了日志之间可能变得不一致的方式。</span><strong><span>虽然在大多数情况下我们试图消除不确定性，但在某些情况下，不确定性实际上提高了可理解性。</span></strong></p><p><span>		</span><strong><span>特别是，随机方法引入了不确定性，但它们倾向于通过以类似的方式处理所有可能的选择来减少状态空间（“选择任何一个；没关系”）。 我们使用随机化来简化Raft领导者选举算法。</span></strong></p><h3 id='12-raft算法核心'><span>1.2 Raft算法核心</span></h3><h4 id='121-三个核心问题'><span>1.2.1 三个核心问题</span></h4><p><span>		</span><span>Raft通过首先选举一个领导者来实现共识，然后让领导者完全负责管理复制的日志。领导者接受来自客户端的日志条目，将它们复制到其他服务器上，并告诉服务器何时可以安全地将日志条目应用到它们的状态机。 拥有领导者可以简化复制日志的管理。 例如，领导者可以在不咨询其他服务器的情况下决定在日志中放置新条目的位置，并且数据以简单的方式从领导者流向其他服务器。 领导者可能会失败或与其他服务器断开连接，在这种情况下会选举出新的领导者。</span></p><p><strong><span>考虑到领导方法，Raft将共识问题分解为三个相对独立的子问题，在后面的小节中讨论：</span></strong></p><p><font color='red'><span>领导者选举（Leader election）</span></font><span>：当现有领导者失败时，必须选择新的领导者。</span></p><p><font color='red'><span>日志复制（Log replication）</span></font><span>：领导者必须接受来自客户端的日志条目并在集群中复制它们，强制其他日志与其自己的日志一致。</span></p><p><font color='red'><span>安全性（Safety）</span></font><span>：Raft的关键安全属性是Figure 2中的状态机安全属性：</span><font color='orange'><span>如果任何服务器已将特定日志条目应用到其状态机（也就是已经提交的日志），则没有其他服务器可以对同一日志索引应用不同的命令。</span></font><span>这样就确保了日志条目的安全。</span></p><h4 id='122-raft共识算法一些约定'><span>1.2.2 Raft共识算法一些约定</span></h4><p><img src="C:\Users\Waitfou\AppData\Roaming\Typora\typora-user-images\image-20230710165237715.png" referrerpolicy="no-referrer" alt="image-20230710165237715"></p><p><span>                                                    </span><strong><span>Figure 2: Raft 保证这些属性中的每一个在任何时候都是真实的。 节号表示讨论每个属性的位置。</span></strong></p><p><font color='red'><span>选举安全性（Election Safety）</span></font><span>：在给定的任期中最多只能选出一个领导者（$5.2）。</span></p><p><font color='red'><span>领导者追加唯一性（Leader Append-Only）</span></font><span>：领导者不会覆盖或删除其日志中的条目，只会追加新的条目（$5.3）。</span></p><p><font color='red'><span>日志匹配性（Log Matching）</span></font><span>：如果两个日志包含相同索引和任期的条目，则这些日志在给定索引之前的所有条目都是相同的（$5.3）。</span></p><p><font color='red'><span>领导者完整性（Leader Completeness）</span></font><span>：如果在给定任期中提交了一个日志条目，则该条目将存在于所有更高编号任期的领导者的日志中（$5.4）。</span></p><p><font color='red'><span>状态机安全性（State Machine Safety）</span></font><span>：如果服务器已将某个索引上的日志条目应用于其状态机，那么其他服务器将永远不会为相同索引应用不同的日志条目（$5.4.3）。</span></p><p><span>以上是对这些描述的翻译，这些描述是关于分布式共识算法中的一些重要性质和保证。它们描述了选举的安全性、领导者的行为规则、日志的一致性和完整性，以及状态机的安全性。</span></p><p><span>需要注意的是，具体的实现和算法细节可能因不同的共识算法而有所不同，因此这只是一个基于常见情况的翻译，并不能确保适用于所有情况。具体的算法实现应参考相应的文档或算法规范。</span></p><h4 id='123-raft算法基础'><span>1.2.3 Raft算法基础</span></h4><p><span>		</span><span>一个Raft集群包含多个服务器； 五是一个典型的数字，它允许系统容忍两次故障。 在任何给定时间，每个服务器都处于三种状态之一：</span><strong><span>领导者（leader）、追随者（follower）或候选者（candidate）。</span></strong></p><p><span>		</span><span>在正常操作中，只有一个领导者，所有其他服务器都是追随者。 追随者是被动的：他们不自己发出请求，只是简单地响应领导者和候选者的请求。 领导者处理所有客户端请求（如果客户端请求跟随者，则跟随者将其重定向到领导者）。 </span><strong><span>第三种状态，候选者，用于选举新的领导者。</span></strong></p><p><strong><span>Raft共识算法的简要总结：</span></strong></p><p><img src="C:\Users\Waitfou\AppData\Roaming\Typora\typora-user-images\image-20230710171303066.png" referrerpolicy="no-referrer" alt="image-20230710171303066"></p><p><span>																	</span><span>Figure 3: Raft 共识算法的简要总结（不包括成员变更和日志压缩）。 </span></p><p><strong><span>左上框中的服务器行为被描述为一组独立且重复触发的规则。 §5.2 等节号表示讨论特定功能的位置。 正式规范更准确地描述了该算法。</span></strong></p><p><font color='orange'><span>State</span></font></p><p><font color='red'><span>在所有服务器中持久的状态：（在响应RPC请求之前在稳定存储上更新）</span></font></p><p><span>currentTerm: 最近的任期服务器已经看见（在服务器第一次启动的时候，初始化为0，单调增加）</span></p><p><span>votedFor：在当前任期被投票的候选者Id（如果没有候选者，就是null）</span></p><p><span>log[]：log实体，每一个实体包含状态机命令，并且当日志实体被leader接收（初始为1）</span></p><p><font color='red'><span>在所有服务器中的Volatile状态：</span></font></p><p><span>commitIndex：已知的被提交的最高的日志实体索引（初始化为0，单调递增）</span></p><p><span>lastApplied：已经被应用到状态机上的最高的日志实体索引（初始为0，单调递增）</span></p><p><font color='red'><span>在leaders中的Volatile状态：</span></font></p><p><span>nextIndex[] : 对于每一个服务器，将要发送给它的下一个日志实体的索引（初始化为最后一个日志实体的索引值+1）</span></p><p><span>matchIndex[]: 对于每一个服务器，已知的被复制到服务器上的最高的日志实体索引号。（初始化为0，单调递增）</span></p><p><font color='orange'><span>AppendEntries RPC</span></font></p><p><span>由leader调用去复制log日志实体。也可以作为心跳</span></p><p><font color='red'><span>参数：</span></font></p><p><span>term: leader的任期</span></p><p><span>leaderId：为了follower节点能够重定向到客户端</span></p><p><span>prevLogIndex：新记录之前的日志条目索引</span></p><p><span>prevLogTerm：prevLogIndex日志实体的任期号</span></p><p><span>entries[]：将要存放的日志实体（如果是空，表示是心跳，为了提高效率，可能会发送超过一个）</span></p><p><span>leaderCommit：leader的commitIndex</span></p><p><font color='red'><span>结果：</span></font></p><p><span>term：请求的节点的当前任期，为了leader方便去更新自己</span></p><p><span>success：如果follower节点包含了匹配prevLogIndex和prevLogTerm的日志实体，那么就返回true</span></p><p><font color='red'><span>接受方实现：</span></font></p><p><span>1、如果收到的RPC请求中的任期号term小于当前节点的当前任期，那么就回复false</span></p><p><span>2、如果当前节点的日志中没有包含RPC中prevLogIndex索引下，且任期与prevLogTerm匹配的日志实体，那么就返回false。</span></p><p><span>3、如果现存的日志中与新的日志冲突（相同的索引，但是任期不同），那么删除现存的日志实体，并且所有后面的日志实体。</span></p><p><span>4、在日志中追加不存在的新的任何的日志实体。</span></p><p><span>5、如果leaderCommit &gt; commintIndex，那么设置commitIndex = min(leaderCommit, 最后一个新的日志实体的索引)。</span></p><p><font color='orange'><span>RequestVote RPC</span></font></p><p><span>由候选者调用去收集投票</span></p><p><font color='red'><span>参数：</span></font></p><p><span>term：候选者的任期</span></p><p><span>candidateId：请求投票的候选者Id</span></p><p><span>lastLogIndex：候选者的最后一个日志实体的索引</span></p><p><span>lastLogIndex：候选者的最后一个日志实体的任期号</span></p><p><font color='red'><span>结果：</span></font></p><p><span>term：被请求节点的当前任期，为了候选者去更新自己</span></p><p><span>voteGranted：投票结果，如果是true，表示同意候选者当选。</span></p><p><font color='red'><span>接受方实现：</span></font></p><p><span>1、如果我的任期比请求方大，那么就返回false。</span></p><p><span>2、如果votedFor为null或者为candidateId，并且candidate的日志至少与接收者的日志保持最新，那么授予投票权。</span></p><p><font color='orange'><span>Rules for Servers</span></font></p><p><font color='red'><span>所有服务器：</span></font></p><p><span>1、如果commitIndex  &gt; lastApplied。那么递增lastApplied，并且应用log[lastApplied]到状态机。</span></p><p><span>2、如果RPC请求或者回复包含任期T 大于我当前的任期，那么设置当前任期为T，并且把自己转换成follower</span></p><p><font color='red'><span>跟随者节点：</span></font></p><p><span>1、对来自于候选者和leader节点的RPC请求进行回复</span></p><p><span>2、如果选举超时，当前节点既没有收到来自当前领导者的附加日志条目(Append Entries)远程过程调用(RPC)，也没有将投票授予候选者，那么将转变为候选者。</span></p><p><font color='red'><span>候选者：</span></font></p><p><span>在转变为候选者后，开始选举：</span></p><ol><li><p><span>增加当前任期（Increment currentTerm）。</span></p></li><li><p><span>给自己投票（Vote for self）。</span></p></li><li><p><span>重置选举定时器（Reset election timer）。</span></p></li><li><p><span>向所有其他服务器发送请求投票的远程过程调用（RPC）（Send Request Vote RPCs to all other servers）。</span></p><p><span>如果收到大多数服务器的选票（If votes received from majority of servers），则成为领导者（become leader）。</span></p><p><span>如果收到新领导者的附加日志条目远程过程调用（RPC）（If AppendEntries RPC received from new leader），则转变为跟随者（convert to follower）。</span></p><p><span>如果选举超时（If election timeout elapses），则开始新的选举。</span></p></li></ol><p><font color='red'><span>领导者（Leaders）：</span></font></p><ol start='' ><li><p><span>在选举后：向每个服务器发送初始的空附加日志条目远程过程调用（RPC）（心跳消息），以防止选举超时（S5.2）。</span></p></li><li><p><span>如果从客户端接收到命令：将条目追加到本地日志，</span><strong><span>等待条目应用到状态机后进行响应（$5.3）。</span></strong></p></li><li><p><span>如果对于某个跟随者，如果Leader的最后的日志索引（last log index）大于等于其下一索引（nextIndex）：发送带有从nextIndex开始的日志条目的附加日志条目远程过程调用（RPC）（$5.3）。</span></p><p><span>如果附加日志成功：更新跟随者的nextIndex和matchIndex（$5.3）。</span></p><p><span>如果由于日志不一致导致附加日志失败：减少nextIndex并重试（$5.3）。</span></p></li><li><p><span>如果存在一个N满足N &gt; commitIndex，并且大多数matchIndex[i] ≥ N，并且log[N].term == currentTerm：设置commitIndex = N（</span><mjx-container class="MathJax" jax="SVG" style="position: relative;"><svg xmlns="http://www.w3.org/2000/svg" width="4.94ex" height="2.149ex" role="img" focusable="false" viewBox="0 -750 2183.6 950" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" style="vertical-align: -0.452ex;"><defs><path id="MJX-1-TEX-N-35" d="M164 157Q164 133 148 117T109 101H102Q148 22 224 22Q294 22 326 82Q345 115 345 210Q345 313 318 349Q292 382 260 382H254Q176 382 136 314Q132 307 129 306T114 304Q97 304 95 310Q93 314 93 485V614Q93 664 98 664Q100 666 102 666Q103 666 123 658T178 642T253 634Q324 634 389 662Q397 666 402 666Q410 666 410 648V635Q328 538 205 538Q174 538 149 544L139 546V374Q158 388 169 396T205 412T256 420Q337 420 393 355T449 201Q449 109 385 44T229 -22Q148 -22 99 32T50 154Q50 178 61 192T84 210T107 214Q132 214 148 197T164 157Z"></path><path id="MJX-1-TEX-N-2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"></path><path id="MJX-1-TEX-N-33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="35" xlink:href="#MJX-1-TEX-N-35"></use><use data-c="2E" xlink:href="#MJX-1-TEX-N-2E" transform="translate(500,0)"></use><use data-c="33" xlink:href="#MJX-1-TEX-N-33" transform="translate(778,0)"></use></g><g data-mml-node="mi" transform="translate(1278,0)"><text data-variant="italic" transform="scale(1,-1)" font-size="884px" font-family="serif" font-style="italic">，</text></g></g></g></svg><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mn>5.3</mn><mi>，</mi></math></mjx-assistive-mml></mjx-container><script type="math/tex">5.3，</script><span>5.4）。</span></p></li></ol><p><span>以上是对该段描述的翻译，涉及到领导者在分布式共识算法中的一些行为和操作。这段描述中包含了领导者在不同情况下的处理逻辑，如发送心跳消息、处理客户端命令、同步日志等。</span></p><p><span>需要注意的是，具体的实现和算法细节可能因不同的共识算法而有所不同，因此这只是一个基于常见情况的翻译，并不能确保适用于所有情况。具体的算法实现应参考相应的文档或算法规范。</span></p><p><img src="C:\Users\Waitfou\AppData\Roaming\Typora\typora-user-images\image-20230710204417878.png" referrerpolicy="no-referrer" alt="image-20230710204417878"></p><p><span>																											</span><span>Figure 4: 服务器状态。 </span></p><p><span>		</span><span>追随者只响应来自其他服务器的请求。 如果一个追随者没有收到任何通讯，它就成为候选者并发起选举。 从整个集群中获得大多数选票的候选者成为新的领导者。 领导者通常会一直运作到失败为止。</span></p><p><span>		</span><span>Raft 将时间划分为任意长度的任期（term），如 Figure 5 所示。任期用连续的整数编号。每个任期都以选举开始，其中一名或多名候选者试图成为第 5.2 节所述的领导者。如果候选人赢得选举，那么它将在该任期的剩余时间内担任领导者。 在某些情况下，选举会导致分裂投票。 在这种情况下，任期将以没有领导者结束； 新任期（包括新选举）即将开始。 Raft 确保在给定任期内至多有一个领导者。</span></p><p><img src="C:\Users\Waitfou\AppData\Roaming\Typora\typora-user-images\image-20230710204723188.png" referrerpolicy="no-referrer" alt="image-20230710204723188"></p><p><span>																						</span><span>  Figure 5: 时间分为任期，每个任期从选举开始</span></p><p><span>		</span><span>选举成功后，一个领导者管理集群直到任期结束。 有些选举失败，在这种情况下，任期结束时不会选择领导者。 可以在不同服务器上的不同时间观察到任期之间的转换。</span></p><p><span>		</span><strong><span>每当服务器通信时，都会交换当前任期；如果一个服务器的当前任期小于另一个，则它将其当前任期更新为较大的值。 如果候选者或领导者发现其任期</span></strong>
<strong><span>已过期，则会立即恢复为追随者状态。 如果服务器收到带有陈旧任期号的请求，它会拒绝该请求。</span></strong></p><p><span>		</span><span>Raft 服务器使用远程过程调用 (RPC) 进行通信，基本的共识算法只需要两种类型的RPC。 </span><strong><span>RequestVote RPC 由候选者在选举期间发起（第 5.2 节），AppendEntries RPC由领导者发起以复制日志条目并提供一种心跳形式（第 5.3 节）</span></strong><span>。 第 7 节添加了第三个 RPC，用于在服务器之间传输快照。如果服务器没有及时收到响应，它们会重试 RPC，并且它们会并行发出 RPC 以获得最佳性能。</span></p><h4 id='124-leader选举'><span>1.2.4 Leader选举</span></h4><p><span>		</span><span>Raft使用心跳机制来触发领导者选举。 当服务器启动时，它们以跟随者的身份开始。只要服务器从领导者或候选者那里收到有效的RPC，它就会保持跟随者状态。</span></p><p><span>		</span><span>领导者定期向所有跟随者发送心跳（不携带日志条目的AppendEntries RPC），以维护自己的权威。 如果跟随者在称为选举超时（election timeout）的一段时间内没有收到任何通信，</span><strong><span>那么它会假定没有可行的领导者并开始选举以选择新的领导者。</span></strong></p><p><span>		</span><span>为了开始选举，追随者增加其当前任期并转换到候选者状态。 然后它为自己投票并向集群中的每个其他服务器</span><font color='red'><span>并行</span></font><span>发出RequestVote RPC。</span></p><p><strong><span>候选者一直处于这种状态，直到发生以下三种情况之一：</span></strong></p><p><span>（a）它赢得了选举，</span></p><p><span>（b）其他服务器确立了自己的领导地位，或者</span></p><p><span>（c）一段时间内没有赢家。</span></p><p><span>这些结果将在下面的段落中分别讨论。</span></p><p><span>		</span><span>如果一个候选者在同一任期内获得了整个集群中大多数服务器的投票，那么它就赢得了选举。每台服务器在给定的任期内最多为一名候选者投票，以先到先得为原则。</span></p><p><span>		</span><span>少数服从多数的原则保证了最多只有一名候选者能够在某一任期内赢得选举（Figure 2中的选举安全（Election Safety））。</span></p><p><span>		</span><span>一旦一个候选者在选举中获胜，它就成为领导者。然后，它向所有其他服务器发送心跳信息，以建立其权威并防止新的选举。</span></p><p><span>		</span><span>在等待投票时，候选者可能会收到来自另一台声称是领导者的服务器的 AppendEntriesRPC。 如果领导者的任期（包含在其 RPC中）至少与候选者的当前任期一样大，则候选者承认领导者是合法的并返回到追随者状态。</span><strong><span>如果 RPC 中的任期小于候选者的当前任期，则候选者拒绝 RPC 并继续处于候选者状态。</span></strong></p><p><span>		</span><font color='red'><span>第三种可能的结果是候选者既不赢也不输：如果许多追随者同时成为候选者，则可以平分选票，从而没有候选者获得多数票。发生这种情况时，每个候选者都会超时并通过增加其任期并启动另一轮 RequestVote RPC 来开始新的选举。 然而，如果不采取额外措施，分裂投票可能会无限期地重复。</span></font><span>这种情况就是任期以没有领导者结束。</span></p><p><strong><span>那么怎么解决可能出现的无限期分裂投票呢？</span></strong></p><p><span>		</span><span>Raft 使用随机化的选举超时（election timeout）来确保分裂投票很少见并且可以快速解决。为了首先防止分裂投票，选举超时是从固定间隔（例如，150-300毫秒）中随机选择的。 这分散了服务器，因此在大多数情况下只有一个服务器会超时； 它赢得了选举，并在其他服务器超时之前发出心跳。 相同的机制用于处理分裂投票。每个候选者在选举开始时重新启动其随机选举超时，并在开始下一次选举之前等待该超时结束； 这减少了在新选举中再次出现分裂投票的可能性。9.3节展示了这种方法可以快速选出领导者。</span></p><p><span>		</span><strong><span>tips：最初论文作者计划使用排名系统：为每个候选者分配一个唯一的排名，用于在竞争候选者之间进行选择。如果一个候选者发现了另一个排名更高的候选者，它会回到追随者状态，以便排名更高的候选者更容易赢得下一次选举。我们发现这种方法在可用性方面产生了微妙的问题（如果排名较高的服务器出现故障，排名较低的服务器可能需要超时并再次成为候选者，但如果时间过早，它可能会重置选举领导者的进程).我们对算法进行了多次调整，但每次调整后都会出现新的极端情况。 最终我们得出结论，随机重试方法更加明显和易于理解。</span></strong></p><p><font color='orange'><span>以上就是Leader选举的相关知识，相对容易理解。</span></font></p><h4 id='125-日志复制'><span>1.2.5 日志复制</span></h4><p><span>		</span><span>一旦领导者被选出，它就开始为客户请求提供服务。 每个客户端请求都包含要由复制状态机执行的命令。领导者将该命令作为新条目附加到其日志中，然后向每个其他服务器</span><font color='red'><span>并行</span></font><span>发出 AppendEntries RPC 以复制该条目。当条目已被安全复制（如下所述）后，</span><strong><span>领导者将条目应用于其状态机并将该执行的结果返回给客户端。</span></strong><span>（提交之后，如果应用了就要向客户端发送回复信息）</span></p><p><span>如果跟随者崩溃或运行缓慢，或者网络数据包丢失，</span><strong><span>领导者会无限期地重试 AppendEntriesRPC（即使在它已经响应客户端之后）直到所有跟随者最终存储所有日志条目。</span></strong></p><p><span>日志的组织方式如 Figure 6 所示。每个日志条目都存储一个状态机命令以及领导者收到该条目时的任期号。日志条目中的任期号用于检测日志之间的不一致，并确保Figure 2中的某些属性。每个日志条目还有一个整数索引，用于标识其在日志中的位置。</span></p><p><img src="C:\Users\Waitfou\AppData\Roaming\Typora\typora-user-images\image-20230710212330525.png" referrerpolicy="no-referrer" alt="image-20230710212330525"></p><p><span>																					</span><span>Figure 6: 日志是由条目组成的，这些条目按顺序编号。</span></p><p><span>		</span><span>每个条目都包含创建它的任期（每个框中的数字）和状态机的命令。</span><strong><span>如果一个条目已被安全复制，那么该条目就被认为是已提交的。（但是提交之后还未应用，后续需要应用到状态机上）。</span></strong></p><p><span>		</span><span>领导者决定何时将日志条目应用到状态机是安全的； 可以被安全地应用到状态机的条目称为已提交的。Raft保证已提交的条目是持久的，并且最终会被所有可用的状态机执行。一旦创建条目的领导者已将其复制到大多数服务器（例如，Figure 6中的条目7），那么该日志就被称为已提交的（此时将该日志条目应用到状态机是安全的）。这也会提交领导者日志中所有先前的条目，包括前任领导者创建的条目。5.4 节讨论了在领导者变更后应用此规则时的一些微妙之处，并且还表明此提交定义是安全的。 领导者跟踪它知道的已提交条目的最高索引，并将该索引包含在未来的AppendEntries RPC（包括心跳）中，以便其他服务器最终找到。 一旦跟随者得知日志条目已提交，它会将条目应用于其本地状态机（按日志顺序）。</span></p><p><strong><span>Raft 维护了以下属性，它们共同构成了 Figure 2中的日志匹配（Log Matching ）属性：</span></strong></p><ol><li><span>如果不同日志中的两个条目具有相同的索引和任期，则它们存储相同的命令。</span></li><li><span>如果不同日志中的两个条目具有相同的索引和任期，则在该条目之前的所有条目都是相同的。</span></li></ol><p><span>第一个属性源于这样一个事实，即领导者在给定任期内最多创建一个具有给定日志索引的条目，并且日志条目永远不会改变它们在日志中的位置。</span></p><p><span>第二个属性由 AppendEntries 执行的简单一致性检查保证。 当发送 AppendEntries RPC 时，</span><strong><span>领导者在其日志中包含紧接在新条目之前的条目的索引和任期。</span></strong></p><p><strong><span>如果跟随者在其日志中没有找到具有相同索引和任期的条目，那么它会拒绝新条目。 一致性检查作为一个归纳步骤：</span></strong></p><p><span>		</span><span>日志的初始空状态满足日志匹配属性，并且只要追加日志，一致性检查就会保留日志匹配属性。 因此，每当AppendEntries 成功返回时，领导者就知道了跟随者的日志与自己的日志相同。</span></p><p><span>		</span><span>在正常运行期间，领导者和跟随者的日志保持一致，</span><strong><span>因此AppendEntries一致性检查永远不会失败</span></strong><span>。 但是，领导者崩溃可能会使日志不一致</span><strong><span>（旧领导者可能没有完全复制其日志中的所有条目）</span></strong></p><p><span>		</span><span>这些不一致可能会导致一系列领导者和追随者崩溃。 Figure 7说明了跟随者的日志可能与新领导者的日志不同的情况。 跟随者可能缺少领导者中存在的条目，它可能具有领导者中不存在的额外条目，或两者兼而有之。 日志中缺失和多余的条目可能跨越多个任期。</span></p><p><img src="C:\Users\Waitfou\AppData\Roaming\Typora\typora-user-images\image-20230710215716850.png" referrerpolicy="no-referrer" alt="image-20230710215716850"></p><p><span>																		</span><strong><span>Figure 7: 当领导者上台时，追随者日志中可能会出现任何场景 (a–f)。</span></strong><span> </span></p><p><span>																				</span><span>每个方框代表一个日志条目； 框中的数字是它的任期。</span></p><p><span>		</span><span>追随者可能缺少条目 (a–b)，可能有额外的未提交条目 (c–d)，或两者都有 (e–f)。 例如，如果该服务器是任期 2 的领导者，则可能会发生场景 (f)，向其日志添加多个条目，然后在提交其中任何一个之前崩溃；它很快重新启动，成为第 3 任期的领导者，并在其日志中添加了更多条目</span><strong><span>；在任期3或任期2中的任何条目被提交之前，服务器再次崩溃并保持停机几个任期。</span></strong></p><p><span>		</span><span>在Raft中，领导者通过强制追随者的日志复制自己的日志来处理不一致。 这意味着跟随者日志中的冲突条目将被领导者日志中的条目覆盖。 第5.4节将表明，在再加上一个限制时，这是安全的。</span></p><p><strong><span>那么怎么使得跟随者和自己的日志条目一致呢？</span></strong></p><p><span>为了使跟随者的日志与其自己的一致，领导者必须找到在跟随者的日志中和自己一致的最新日志条目，</span><strong><span>然后在跟随者日志中删除该点之后的所有条目，并将该点之后的所有领导者日志条目发送给跟随者。</span></strong></p><p><span>领导者</span><strong><span>为每个跟随者维护一个 nextIndex</span></strong><span>，这是领导者将发送给该跟随者的下一个日志条目的索引。当一个领导者第一次掌权时，它会将所有nextIndex 值初始化为其日志中最后一个索引之后的索引（Figure 7 中的 11）。如果跟随者的日志与领导者的日志不一致，则在下一个 AppendEntries RPC 中，</span><strong><span>一致性检查将失败。 拒绝后，领导者递减 nextIndex 并重试 AppendEntries RPC。最终 nextIndex将达到领导者和跟随者日志匹配的点。</span></strong></p><p><span>当发生这种情况时，AppendEntries RPC 将成功，它会删除跟随者日志中的所有冲突条目</span><strong><span>（因为没有提交，所以是可以删除的。保持强一致性）</span></strong><span>并追加领导者日志中的条目（如果有的话）。 一旦 AppendEntries RPC 成功，跟随者的日志与领导者的一致，并且在剩余的任期内保持这种状态。</span></p><p><span>		</span><span>这种日志复制机制展示了第 2 节中描述的理想的共识属性：只要大多数服务器正常运行，Raft 就可以接受、复制和应用新的日志条目； 在正常情况下，可以通过单轮RPC 将新条目复制到集群的大多数； 单个慢速跟随者不会影响性能。</span></p><h2 id='2加深理解的文章'><span>2、加深理解的文章</span></h2><h3 id='21-编写前的-raft-理论基础'><span>2.1 编写前的 Raft 理论基础</span></h3><p><span>Raft 为了算法的可理解性，将算法分成了 4 个部分。</span></p><ol><li><span>leader 选举</span></li><li><span>日志复制</span></li><li><span>成员变更</span></li><li><span>日志压缩</span></li></ol><p><span>		</span><span>Raft leader 节点会将客户端的请求都封装成日志，发送到各个 follower 中，如果集群中超过一半的 follower 回复成功，那么这个日志就可以被提交（commit），这个 commit 可以理解为 ACID 的 D ，即持久化。当日志被持久化到磁盘，后面的事情就好办了。</span></p><p><span>而第三点则是为了节点的扩展性。第四点是为了性能。相比较 leader 选举和 日志复制，不是那么的重要，可以说，如果没有成员变更和日志压缩，也可以搞出一个可用的 Raft 分布式系统，但没有 leader 选举和日志复制，是万万不能的。</span></p><p><span>因此，本文和本项目将重点放在 leader 选举和日志复制。</span></p><h3 id='22-实现步骤'><span>2.2 实现步骤</span></h3><p><span>实现目标：基于 Raft 论文实现 Raft 核心功能，即 Leader 选举 &amp; 日志复制。</span></p><p><span>Raft 核心组件包括：一致性模块，RPC 通信，日志模块，状态机。</span></p><h3 id='23-技术选型'><span>2.3 技术选型</span></h3><ul><li><span>一致性模块，是 Raft 算法的核心实现，通过一致性模块，保证 Raft 集群节点数据的一致性。</span><strong><span>这里我们需要自己根据论文描述去实现</span></strong><span>。</span></li><li><span>RPC 通信，可以使用 HTTP 短连接，也可以直接使用 TCP 长连接，考虑到集群各个节点频繁通信，同时节点通常都在一个局域网内，因此我们选用 TCP 长连接。而 Java 社区长连接框架首选 Netty，这里我们选用蚂蚁金服网络通信框架 SOFA-Bolt（基于 Netty），便于快速开发。</span></li><li><span>日志模块，Raft 算法中，日志实现是基础，考虑到时间因素，我们选用 RocksDB 作为日志存储。</span></li><li><span>状态机，可以是任何实现，其实质就是将日志中的内容进行处理。可以理解为 Mysql binlog 中的具体数据。由于我们是要实现一个 KV 存储，那么可以直接使用日志模块的 RocksDB 组件。</span></li></ul><p><span>以上。我们可以看到，得益于开源世界，我们开发一个 Raft 存储，只需要编写一个“一致性模块”就行了，其他模块都有现成的轮子可以使用，真是美滋滋。</span></p><p><strong><span>日志附加</span></strong></p><p><span>		</span><span>简单来说，当用户向 Leader 发送一个 KV 数据，那么 Leader 需要将 KV数据封装成日志，并行的发送到其他的 follower 节点，只要在指定的超时时间内，有过半几点返回成功，那么久提交（持久化）这条日志，返回客户端成功，否则返回失败。</span></p><p><span>因此，Leader 节点会有一个 ClientKVAck handlerClientRequest(ClientKVReq request) 接口，用于接收用户的 KV 数据，同时，会并行向其他节点复制数据，具体步骤如下：</span></p><ol><li><span>每个节点都可能会接收到客户端的请求，但只有 leader 能处理，所以如果自身不是 leader，则需要转发给 leader。</span></li><li><span>然后将用户的 KV 数据封装成日志结构，包括 term，index，command，</span><font color='red'><span>预提交到本地。</span></font></li><li><span>并行的向其他节点发送数据，也就是日志复制。</span></li><li><span>如果在指定的时间内，过半节点返回成功，那么</span><font color='red'><span>就提交这条日志。</span></font></li><li><span>最后，更新自己的 commitIndex，lastApplied 等信息。</span></li></ol><p><span>注意，复制不仅仅是简单的将这条日志发送到其他节点，这可能比我们想象的复杂，为了保证复杂网络环境下的一致性，Raft 保存了每个节点的成功复制过的日志的 index，即 nextIndex ，因此，如果对方之前一段时间宕机了，那么，从宕机那一刻开始，到当前这段时间的所有日志，都要发送给对方。</span></p><p><span>甚至于，如果对方觉得你发送的日志还是太大，那么就要递减的减小 nextIndex，复制更多的日志给对方。</span><strong><span>注意：这里是 Raft 实现分布式一致性的关键所在</span></strong><span>。</span></p><p><strong><span>再来看看日志接收者的实现步骤：</span></strong></p><ol><li><span>和心跳一样，要先检查对方 term，如果 term 都不对，那么就没什么好说的了。</span></li><li><span>如果日志不匹配，那么返回 leader，告诉他，减小 nextIndex 重试。</span></li><li><span>如果本地存在的日志和 leader 的日志冲突了，以 leader 的为准，删除自身的。</span></li><li><span>最后，将日志应用到状态机，更新本地的 commitIndex，返回 leader 成功。</span></li></ol><p><span>到这里，日志复制的部分就讲完了。</span></p><p><span>注意，实现日志复制的前提是，必须有一个正确的日志存储系统，即我们的 RocksDB，我们在 RocksDB 的基础上，使用一种机制，维护了 每个节点 的LastIndex，无论何时何地，都能够得到正确的 LastIndex，这是实现日志复制不可获取的一部分。</span></p><h3 id='24-动画演示'><span>2.4 动画演示</span></h3><p><span>地址：</span><a href='http://thesecretlivesofdata.com/raft/' target='_blank' class='url'>http://thesecretlivesofdata.com/raft/</a></p><h2 id='3代码复盘'><span>3、代码复盘</span></h2><h3 id='21-sofa-bolt框架介绍'><span>2.1 SOFA-BOlt框架介绍</span></h3><p><span>SOFABolt 是蚂蚁金融服务集团开发的一套基于 Netty 实现的网络通信框架。</span></p><ul><li><span>为了让 Java 程序员能将更多的精力放在基于网络通信的业务逻辑实现上，而不是过多的纠结于网络底层 NIO 的实现以及处理难以调试的网络问题，Netty 应运而生。</span></li><li><span>为了让中间件开发者能将更多的精力放在产品功能特性实现上，而不是重复地一遍遍制造通信框架的轮子，SOFABolt 应运而生。</span></li></ul><p><span>Bolt 名字取自迪士尼动画-闪电狗，是一个基于 Netty 最佳实践的轻量、易用、高性能、易扩展的通信框架。 这些年我们在微服务与消息中间件在网络通信上解决过很多问题，积累了很多经验，并持续的进行着优化和完善，我们希望能把总结出的解决方案沉淀到 SOFABolt 这个基础组件里，让更多的使用网络通信的场景能够统一受益。 目前该产品已经运用在了蚂蚁中间件的微服务 (</span><a href='https://github.com/sofastack/sofa-rpc'><span>SOFARPC</span></a><span>)、消息中心、分布式事务、分布式开关、以及配置中心等众多产品上。</span></p><h4 id='211-功能介绍'><span>2.1.1 功能介绍</span></h4><p><img src="C:\Users\Waitfou\AppData\Roaming\Typora\typora-user-images\image-20230711104906527.png" referrerpolicy="no-referrer" alt="image-20230711104906527"></p><p><strong><span>SOFABolt的基础功能包括：</span></strong></p><ul><li><p><span>基础通信功能 ( remoting-core )</span></p><ul><li><span>基于 Netty 高效的网络 IO 与线程模型运用</span></li><li><span>连接管理 (无锁建连，定时断链，自动重连)</span></li><li><span>基础通信模型 ( oneway，sync，future，callback )</span></li><li><span>超时控制</span></li><li><span>批量解包与批量提交处理器</span></li><li><span>心跳与 IDLE 事件处理</span></li></ul></li><li><p><span>协议框架 ( protocol-skeleton )</span></p><ul><li><span>命令与命令处理器</span></li><li><span>编解码处理器</span></li><li><span>心跳触发器</span></li></ul></li><li><p><span>私有协议定制实现 - RPC 通信协议 ( protocol-implementation )</span></p><ul><li><span>RPC 通信协议的设计</span></li><li><span>灵活的反序列化时机控制</span></li><li><span>请求处理超时 FailFast 机制</span></li><li><span>用户请求处理器 ( UserProcessor )</span></li><li><span>双工通信</span></li></ul><p><strong><span>用法1</span></strong></p></li></ul><p><span>		</span><span>将 SOFABolt 用作一个远程通信框架，使用者可以不用关心如何实现一个私有协议的细节，直接使用我们内置的 RPC 通信协议。可以非常简单的启动客户端与服务端，同时注册一个用户请求处理器，即可完成远程调用。同时，像连接管理、心跳等基础功能特性都默认可以使用。 当前支持的调用类型如下图所示：</span></p><p><img src="C:\Users\Waitfou\AppData\Roaming\Typora\typora-user-images\image-20230711105336036.png" referrerpolicy="no-referrer" alt="image-20230711105336036"></p><h3 id='22-rocksdb框架介绍'><span>2.2 RocksDB框架介绍</span></h3><p><span>RocksDB 是一个高性能的持久化键值存储库，由 Facebook 开发并后来开源。它基于 Google 的 LevelDB 构建，但在性能和功能上进行了改进和优化。</span></p><p><span>RocksDB 具有以下特点：</span></p><ol start='' ><li><span>键值存储：RocksDB 提供了一个键值存储接口，允许用户将任意大小的键值对持久化存储。</span></li><li><span>高性能：RocksDB 在读取和写入方面具有出色的性能。它使用了先进的存储引擎技术，如 MemTable、SSTable 和 Bloom Filter，以实现快速的读写操作。</span></li><li><span>内存和磁盘结合：RocksDB 可以配置使用内存和磁盘进行存储。它使用内存来缓存热数据，以提高读取性能，并将冷数据持久化到磁盘上。</span></li><li><span>支持多种数据结构：除了基本的键值对存储之外，RocksDB 还支持各种数据结构，如有序映射、有序集合、位图等。这使得它适用于不同类型的应用场景。</span></li><li><span>可配置性：RocksDB 提供了许多配置选项，可以根据应用程序的需求进行优化。用户可以调整存储引擎、内存使用、压缩算法等参数，以满足特定的性能和存储需求。</span></li><li><span>支持事务：RocksDB 支持原子性的读写事务，保证数据的一致性和可靠性。</span></li><li><span>多语言支持：RocksDB 提供了多种编程语言的接口和绑定，如 C++, Java, Python 等，使得开发者可以方便地在不同的编程环境中使用。</span></li></ol><p><span>RocksDB 在多个领域得到了广泛的应用，包括大规模分布式存储系统、数据库系统、日志处理和缓存等。它的高性能和可扩展性使得它成为许多系统和应用程序的首选存储引擎之一。</span></p><h3 id='23-代码结合论文理解'><span>2.3 代码结合论文理解</span></h3><h4 id='231-rpc实现'><span>2.3.1 RPC实现</span></h4><p><strong><span>RaftClientRPC.java</span></strong></p><p><strong><span>客户端RPC请求创建：</span></strong></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 11.0703px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">private</span> <span class="cm-keyword">final</span> <span class="cm-keyword">static</span> <span class="cm-variable">com</span>.<span class="cm-variable">alipay</span>.<span class="cm-variable">remoting</span>.<span class="cm-variable">rpc</span>.<span class="cm-variable">RpcClient</span> <span class="cm-variable">CLIENT</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">com</span>.<span class="cm-variable">alipay</span>.<span class="cm-variable">remoting</span>.<span class="cm-variable">rpc</span>.<span class="cm-variable">RpcClient</span>();</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 26px;"></div><div class="CodeMirror-gutters" style="display: none; height: 26px;"></div></div></div></pre><p><span>通过借助蚂蚁金服SOFA-Bolt框架进行RPC通信。</span></p><p><strong><span>发送RPC请求：</span></strong></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 12.0703px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre>x</pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-meta">@Override</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-operator">&lt;</span><span class="cm-variable">R</span><span class="cm-operator">&gt;</span> <span class="cm-variable">R</span> <span class="cm-def">send</span>(<span class="cm-variable">Request</span> <span class="cm-variable">request</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">timeout</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//初始化返回结果</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Response</span><span class="cm-operator">&lt;</span><span class="cm-variable">R</span><span class="cm-operator">&gt;</span> <span class="cm-variable">result</span>;</span></pre><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">try</span>{</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//invokeSync是同步调用</span></span></pre><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">result</span> <span class="cm-operator">=</span> (<span class="cm-variable">Response</span><span class="cm-operator">&lt;</span><span class="cm-variable">R</span><span class="cm-operator">&gt;</span>) <span class="cm-variable">CLIENT</span>.<span class="cm-variable">invokeSync</span>(<span class="cm-variable">request</span>.<span class="cm-variable">getUrl</span>(), <span class="cm-variable">request</span>, <span class="cm-variable">timeout</span>);</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">result</span>.<span class="cm-variable">getResult</span>();</span></pre><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  } <span class="cm-keyword">catch</span> (<span class="cm-variable">RemotingException</span> <span class="cm-variable">e</span>) {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">throw</span> <span class="cm-keyword">new</span> <span class="cm-variable">RaftRemotingException</span>(<span class="cm-string">"rpc RaftRemotingException "</span>, <span class="cm-variable">e</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  } <span class="cm-keyword">catch</span> (<span class="cm-variable">InterruptedException</span> <span class="cm-variable">e</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// ignore</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-atom">null</span>;</span></pre><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 394px;"></div><div class="CodeMirror-gutters" style="display: none; height: 394px;"></div></div></div></pre><h4 id='232-用户端实现'><span>2.3.2 用户端实现</span></h4><p><span>用户端会向节点集群发送KV键值对数据。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 11.0703px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">private</span> <span class="cm-variable">AtomicLong</span> <span class="cm-variable">count</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">AtomicLong</span>(<span class="cm-number">3</span>);</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 26px;"></div><div class="CodeMirror-gutters" style="display: none; height: 26px;"></div></div></div></pre><p><span>这段代码声明了一个私有的 </span><code>AtomicLong</code><span> 类型的变量 </span><code>count</code><span>，并将其初始化为 3。</span></p><p><span>		</span><code>AtomicLong</code><span> 是 Java 并发包（</span><code>java.util.concurrent.atomic</code><span>）中提供的原子操作类之一，用于进行原子性的长整型操作。它提供了一组原子操作方法，可以对 </span><code>long</code><span> 类型的值进行安全地更新和操作，避免多线程并发访问时的数据竞争和不一致性。</span></p><p><span>	</span><span>在这段代码中，</span><code>count</code><span> 变量被声明为 </span><code>AtomicLong</code><span> 类型，这意味着它可以安全地在多个线程中进行读取和写入操作，而不需要显式地进行同步或加锁。同时，通过 </span><code>new AtomicLong(3)</code><span> 进行初始化，将初始值设置为 3。</span></p><p><span>		</span><strong><code>AtomicLong</code><span> 提供了一些常用的方法，如 </span><code>get()</code><span> 获取当前值，</span><code>set()</code><span> 设置新的值，</span><code>getAndIncrement()</code><span> 原子性地获取当前值并自增，</span><code>compareAndSet()</code><span> 原子性地比较并设置新值等等。</span></strong></p><p><span>		</span><strong><span>通过使用 </span><code>AtomicLong</code><span> 类型的变量，可以确保对 </span><code>count</code><span> 变量的读取和更新操作是原子的，并且在多线程环境下保持线程安全性。这在需要进行高效且线程安全的计数操作时非常有用。</span></strong></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 11.0703px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre>x</pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-variable-3">String</span> <span class="cm-def">put</span>(<span class="cm-variable-3">String</span> <span class="cm-variable">key</span>, <span class="cm-variable-3">String</span> <span class="cm-variable">value</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 采用的是轮询,如果节点不是Leader节点，那么存放的消息会被转发到Leader节点。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">int</span> <span class="cm-variable">index</span> <span class="cm-operator">=</span> (<span class="cm-variable-3">int</span>) (<span class="cm-variable">count</span>.<span class="cm-variable">incrementAndGet</span>() <span class="cm-operator">%</span> <span class="cm-variable">list</span>.<span class="cm-variable">size</span>());</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 获取挑选到的服务器的地址</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">String</span> <span class="cm-variable">addr</span> <span class="cm-operator">=</span> <span class="cm-variable">list</span>.<span class="cm-variable">get</span>(<span class="cm-variable">index</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 包装客户端请求参数</span></span></pre><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">ClientKVReq</span> <span class="cm-variable">obj</span> <span class="cm-operator">=</span> <span class="cm-variable">ClientKVReq</span>.<span class="cm-variable">builder</span>().<span class="cm-variable">key</span>(<span class="cm-variable">key</span>).<span class="cm-variable">value</span>(<span class="cm-variable">value</span>).<span class="cm-variable">type</span>(<span class="cm-variable">ClientKVReq</span>.<span class="cm-variable">PUT</span>).<span class="cm-variable">build</span>();</span></pre></div><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Request</span> <span class="cm-variable">r</span> <span class="cm-operator">=</span> <span class="cm-variable">Request</span>.<span class="cm-variable">builder</span>().<span class="cm-variable">obj</span>(<span class="cm-variable">obj</span>).<span class="cm-variable">url</span>(<span class="cm-variable">addr</span>).<span class="cm-variable">cmd</span>(<span class="cm-variable">Request</span>.<span class="cm-variable">CLIENT_REQ</span>).<span class="cm-variable">build</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">ClientKVAck</span> <span class="cm-variable">response</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">try</span>{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">response</span> <span class="cm-operator">=</span> <span class="cm-variable">CLIENT</span>.<span class="cm-variable">send</span>(<span class="cm-variable">r</span>); <span class="cm-comment">//这里发送之后。服务端的handlerRequest(Request request)就会处理，具体见蚂蚁金服sofa-bolt官方文档</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }<span class="cm-keyword">catch</span> (<span class="cm-variable">Exception</span> <span class="cm-variable">e</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">r</span>.<span class="cm-variable">setUrl</span>(<span class="cm-variable">list</span>.<span class="cm-variable">get</span>((<span class="cm-variable-3">int</span>)((<span class="cm-variable">count</span>.<span class="cm-variable">incrementAndGet</span>())<span class="cm-operator">%</span><span class="cm-variable">list</span>.<span class="cm-variable">size</span>())));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">response</span> <span class="cm-operator">=</span> <span class="cm-variable">CLIENT</span>.<span class="cm-variable">send</span>(<span class="cm-variable">r</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">response</span>.<span class="cm-variable">getResult</span>().<span class="cm-variable">toString</span>();</span></pre><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 523px;"></div><div class="CodeMirror-gutters" style="display: none; height: 523px;"></div></div></div></pre><p><strong><span>ClientKVReq请求参数包装</span></strong></p><p><span>通过采用构建者设计模式：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 11.0703px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre>x</pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">@Getter</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">@Setter</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">@ToString</span></span></pre><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">@Builder</span></span></pre></div><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">ClientKVReq</span> <span class="cm-keyword">implements</span> <span class="cm-variable">Serializable</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-variable-3">int</span> <span class="cm-variable">PUT</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;</span></pre><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-variable-3">int</span> <span class="cm-variable">GET</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>;</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable-3">int</span> <span class="cm-variable">type</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable-3">String</span> <span class="cm-variable">key</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable-3">String</span> <span class="cm-variable">value</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">enum</span> <span class="cm-def">Type</span>{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">PUT</span>(<span class="cm-number">0</span>), <span class="cm-variable">GET</span>(<span class="cm-number">1</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">int</span> <span class="cm-variable">code</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Type</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">code</span>){</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">this</span>.<span class="cm-variable">code</span> <span class="cm-operator">=</span> <span class="cm-variable">code</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-variable">Type</span> <span class="cm-variable">value</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">code</span>){</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">for</span>(<span class="cm-variable">Type</span> <span class="cm-variable">type</span>:<span class="cm-variable">values</span>()){</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span>(<span class="cm-variable">type</span>.<span class="cm-variable">code</span> <span class="cm-operator">==</span> <span class="cm-variable">code</span>){</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">type</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-atom">null</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 732px;"></div><div class="CodeMirror-gutters" style="display: none; height: 732px;"></div></div></div></pre><p><strong><span>Request构建</span></strong></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 11.0703px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre>x</pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">@Builder</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">@Data</span></span></pre><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">Request</span> <span class="cm-keyword">implements</span> <span class="cm-variable">Serializable</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">/** 请求投票 */</span></span></pre><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-keyword">final</span> <span class="cm-variable-3">int</span> <span class="cm-variable">R_VOTE</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">/** 附加日志 */</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-keyword">final</span> <span class="cm-variable-3">int</span> <span class="cm-variable">A_ENTRIES</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">/** 客户端 */</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-keyword">final</span> <span class="cm-variable-3">int</span> <span class="cm-variable">CLIENT_REQ</span> <span class="cm-operator">=</span> <span class="cm-number">2</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">/** 配置变更. add */</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-keyword">final</span> <span class="cm-variable-3">int</span> <span class="cm-variable">CHANGE_CONFIG_ADD</span> <span class="cm-operator">=</span> <span class="cm-number">3</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">/** 配置变更. remove */</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-keyword">final</span> <span class="cm-variable-3">int</span> <span class="cm-variable">CHANGE_CONFIG_REMOVE</span> <span class="cm-operator">=</span> <span class="cm-number">4</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">/** 请求类型 */</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span class="cm-variable-3">int</span> <span class="cm-variable">cmd</span> <span class="cm-operator">=</span> <span class="cm-operator">-</span><span class="cm-number">1</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* param</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">*</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span class="cm-variable-3">Object</span> <span class="cm-variable">obj</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span class="cm-variable-3">String</span> <span class="cm-variable">url</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable">Request</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable">Request</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">cmd</span>, <span class="cm-variable-3">Object</span> <span class="cm-variable">obj</span>, <span class="cm-variable-3">String</span> <span class="cm-variable">url</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">this</span>.<span class="cm-variable">cmd</span> <span class="cm-operator">=</span> <span class="cm-variable">cmd</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">this</span>.<span class="cm-variable">obj</span> <span class="cm-operator">=</span> <span class="cm-variable">obj</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">this</span>.<span class="cm-variable">url</span> <span class="cm-operator">=</span> <span class="cm-variable">url</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 915px;"></div><div class="CodeMirror-gutters" style="display: none; height: 915px;"></div></div></div></pre><p><span>public class Request implements Serializable表示这段代码定义了一个 </span><code>Request</code><span> 类，并实现了 </span><code>Serializable</code><span> 接口。</span></p><p><code>Serializable</code><span> 是一个 Java 标记接口（Marker Interface），用于指示一个类的对象可以被序列化（即转换为字节流），以便在网络传输或持久化存储时进行传递或保存。</span></p><p><span>通过实现 </span><code>Serializable</code><span> 接口，</span><code>Request</code><span> 类表明其对象可以被序列化。这意味着可以将 </span><code>Request</code><span> 对象转换为字节流，以便在网络中进行传输，或者进行持久化存储。</span></p><p><span>在实现 </span><code>Serializable</code><span> 接口后，</span><code>Request</code><span> 类可以使用 Java 序列化机制对其对象进行序列化和反序列化操作。序列化将对象转换为字节流，而反序列化将字节流转换回对象。这使得 </span><code>Request</code><span> 对象可以在不同的 Java 虚拟机之间进行传输，或者可以将其存储在磁盘上以后进行读取。</span></p><p><span>需要注意的是，实现 </span><code>Serializable</code><span> 接口仅是一个标记，并不需要在类中编写任何特定的方法。但是，为了实现自定义的序列化行为，可以通过实现 </span><code>writeObject()</code><span> 和 </span><code>readObject()</code><span> 等方法来控制对象的序列化和反序列化过程。</span></p><p><span>总之，通过在 </span><code>Request</code><span> 类中实现 </span><code>Serializable</code><span> 接口，表明该类的对象可以被序列化，可以在网络传输或存储过程中进行传递或保存。</span></p><h4 id='233-节点端实现'><span>2.3.3 节点端实现</span></h4><p><img src="C:\Users\Waitfou\AppData\Roaming\Typora\typora-user-images\image-20230711143741521.png" referrerpolicy="no-referrer" alt="image-20230711143741521"></p><p><strong><span>节点处理不同类型的RPC请求</span></strong></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 11.0703px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre>x</pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span class="cm-keyword">final</span> <span class="cm-variable">DefaultNode</span> <span class="cm-variable">node</span>;</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// 蚂蚁金服RPC框架的服务器处理端</span></span></pre><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span class="cm-keyword">final</span> <span class="cm-variable">RpcServer</span> <span class="cm-variable">rpcServer</span>; &nbsp; &nbsp;</span></pre></div><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 接收来自客户端的请求，并进行处理</span></span></pre></div><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-meta">@Override</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable">Response</span><span class="cm-operator">&lt;?&gt;</span> <span class="cm-def">handlerRequest</span>(<span class="cm-variable">Request</span> <span class="cm-variable">request</span>) {</span></pre><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">request</span>.<span class="cm-variable">getCmd</span>() <span class="cm-operator">==</span> <span class="cm-variable">Request</span>.<span class="cm-variable">R_VOTE</span>) { <span class="cm-comment">// 处理投票</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-keyword">new</span> <span class="cm-variable">Response</span><span class="cm-operator">&lt;&gt;</span>(<span class="cm-variable">node</span>.<span class="cm-variable">handlerRequestVote</span>((<span class="cm-variable">RvoteParam</span>) <span class="cm-variable">request</span>.<span class="cm-variable">getObj</span>()));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  } <span class="cm-keyword">else</span> <span class="cm-keyword">if</span> (<span class="cm-variable">request</span>.<span class="cm-variable">getCmd</span>() <span class="cm-operator">==</span> <span class="cm-variable">Request</span>.<span class="cm-variable">A_ENTRIES</span>) {<span class="cm-comment">//追加日志</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-keyword">new</span> <span class="cm-variable">Response</span><span class="cm-operator">&lt;&gt;</span>(<span class="cm-variable">node</span>.<span class="cm-variable">handlerAppendEntries</span>((<span class="cm-variable">AentryParam</span>) <span class="cm-variable">request</span>.<span class="cm-variable">getObj</span>()));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  } <span class="cm-keyword">else</span> <span class="cm-keyword">if</span> (<span class="cm-variable">request</span>.<span class="cm-variable">getCmd</span>() <span class="cm-operator">==</span> <span class="cm-variable">Request</span>.<span class="cm-variable">CLIENT_REQ</span>) { <span class="cm-comment">// 处理客户端请求</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-keyword">new</span> <span class="cm-variable">Response</span><span class="cm-operator">&lt;&gt;</span>(<span class="cm-variable">node</span>.<span class="cm-variable">handlerClientRequest</span>((<span class="cm-variable">ClientKVReq</span>) <span class="cm-variable">request</span>.<span class="cm-variable">getObj</span>()));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  } <span class="cm-keyword">else</span> <span class="cm-keyword">if</span> (<span class="cm-variable">request</span>.<span class="cm-variable">getCmd</span>() <span class="cm-operator">==</span> <span class="cm-variable">Request</span>.<span class="cm-variable">CHANGE_CONFIG_REMOVE</span>) { <span class="cm-comment">// 处理改变配置</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-keyword">new</span> <span class="cm-variable">Response</span><span class="cm-operator">&lt;&gt;</span>(((<span class="cm-variable">ClusterMembershipChanges</span>) <span class="cm-variable">node</span>).<span class="cm-variable">removePeer</span>((<span class="cm-variable">Peer</span>) <span class="cm-variable">request</span>.<span class="cm-variable">getObj</span>()));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  } <span class="cm-keyword">else</span> <span class="cm-keyword">if</span> (<span class="cm-variable">request</span>.<span class="cm-variable">getCmd</span>() <span class="cm-operator">==</span> <span class="cm-variable">Request</span>.<span class="cm-variable">CHANGE_CONFIG_ADD</span>) { <span class="cm-comment">// 集群中添加了节点</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-keyword">new</span> <span class="cm-variable">Response</span><span class="cm-operator">&lt;&gt;</span>(((<span class="cm-variable">ClusterMembershipChanges</span>) <span class="cm-variable">node</span>).<span class="cm-variable">addPeer</span>((<span class="cm-variable">Peer</span>) <span class="cm-variable">request</span>.<span class="cm-variable">getObj</span>())); <span class="cm-comment">// 子类可以向父类转型</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-atom">null</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 549px;"></div><div class="CodeMirror-gutters" style="display: none; height: 549px;"></div></div></div></pre><p><span>这里拿 </span><strong><span>//处理客户端</span></strong><span> 请求举例</span></p><p>&nbsp;</p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 11.0703px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre>x</pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">if</span> (<span class="cm-variable">request</span>.<span class="cm-variable">getCmd</span>() <span class="cm-operator">==</span> <span class="cm-variable">Request</span>.<span class="cm-variable">CLIENT_REQ</span>) { <span class="cm-comment">// 处理客户端请求</span></span></pre></div><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-keyword">new</span> <span class="cm-variable">Response</span><span class="cm-operator">&lt;&gt;</span>(<span class="cm-variable">node</span>.<span class="cm-variable">handlerClientRequest</span>((<span class="cm-variable">ClientKVReq</span>) <span class="cm-variable">request</span>.<span class="cm-variable">getObj</span>()));</span></pre></div><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 105px;"></div><div class="CodeMirror-gutters" style="display: none; height: 105px;"></div></div></div></pre><p><span>此时调用处理结点中处理客户端请求的函数node.handlerClientRequest()</span></p><p><span>接下来完成一系列业务逻辑</span></p><p><span>1、判断当前结点状态是否是Leader，如果不是的话就转发request。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 11.0703px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">if</span> (<span class="cm-variable">status</span> <span class="cm-operator">!=</span> <span class="cm-variable">NodeStatus</span>.<span class="cm-variable">LEADER</span>) {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">log</span>.<span class="cm-variable">warn</span>(<span class="cm-string">"I not am leader, only invoke redirect method, leader addr : {}, my addr: {}"</span>, <span class="cm-variable">peerSet</span>.<span class="cm-variable">getLeader</span>(), <span class="cm-variable">peerSet</span>.<span class="cm-variable">getSelf</span>().<span class="cm-variable">getAddr</span>());</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">redirect</span>(<span class="cm-variable">request</span>); <span class="cm-comment">//重定向请求到Leader节点</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 131px;"></div><div class="CodeMirror-gutters" style="display: none; height: 131px;"></div></div></div></pre><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 12.0703px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-meta">@Override</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable">ClientKVAck</span> <span class="cm-def">redirect</span>(<span class="cm-variable">ClientKVReq</span> <span class="cm-variable">request</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Request</span> <span class="cm-variable">r</span> <span class="cm-operator">=</span> <span class="cm-variable">Request</span>.<span class="cm-variable">builder</span>()</span></pre><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  .<span class="cm-variable">obj</span>(<span class="cm-variable">request</span>)</span></pre></div><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  .<span class="cm-variable">url</span>(<span class="cm-variable">peerSet</span>.<span class="cm-variable">getLeader</span>().<span class="cm-variable">getAddr</span>())</span></pre></div><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  .<span class="cm-variable">cmd</span>(<span class="cm-variable">Request</span>.<span class="cm-variable">CLIENT_REQ</span>).<span class="cm-variable">build</span>();</span></pre></div><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/**重定向转发给Leader，还是以客户端的方式封装*/</span></span></pre></div><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">rpcClient</span>.<span class="cm-variable">send</span>(<span class="cm-variable">r</span>);</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 237px;"></div><div class="CodeMirror-gutters" style="display: none; height: 237px;"></div></div></div></pre><p><span>其中peerSet是每个结点的属性，能够知道结点所在的集群中当前的Leader是谁。</span></p><p><img src="C:\Users\Waitfou\AppData\Roaming\Typora\typora-user-images\image-20230711143533966.png" alt="image-20230711143533966" style="zoom:50%;" /></p><p><span>2、如果是Leader结点，那么判断用户端的请求是ClientKVReq.GET还是ClientKVReq.PUT</span></p><p><span>3、如果是ClientKVReq.GET，那么就返回该结点状态机中查询根据键查询出来的值。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 11.0703px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 如果客户端的请求是get请求，那么就就查找并返回给客户端他想要获取的信息</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">request</span>.<span class="cm-variable">getType</span>() <span class="cm-operator">==</span> <span class="cm-variable">ClientKVReq</span>.<span class="cm-variable">GET</span>){</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">LogEntry</span> <span class="cm-variable">logEntry</span> <span class="cm-operator">=</span> <span class="cm-variable">stateMachine</span>.<span class="cm-variable">get</span>(<span class="cm-variable">request</span>.<span class="cm-variable">getKey</span>());</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">logEntry</span> <span class="cm-operator">!=</span> <span class="cm-atom">null</span>){</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-keyword">new</span> <span class="cm-variable">ClientKVAck</span>(<span class="cm-variable">logEntry</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-keyword">new</span> <span class="cm-variable">ClientKVAck</span>(<span class="cm-atom">null</span>);<span class="cm-comment">//如果没找到，返回null</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 209px;"></div><div class="CodeMirror-gutters" style="display: none; height: 209px;"></div></div></div></pre><p><span>注意：每一个结点都有一个对应的状态机StateMachine</span></p><p><span>4、如果是PUT请求，那么就要把用户端传来的KV键值对包装成logEntry日志实体。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 11.0703px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 如果是PUT请求，那么久生成日志实体</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">LogEntry</span> <span class="cm-variable">logEntry</span> <span class="cm-operator">=</span> <span class="cm-variable">LogEntry</span>.<span class="cm-variable">builder</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  .<span class="cm-variable">command</span>(<span class="cm-variable">Command</span>.<span class="cm-variable">builder</span>(). <span class="cm-comment">//客户端发送的键值对</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">key</span>(<span class="cm-variable">request</span>.<span class="cm-variable">getKey</span>()).</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">value</span>(<span class="cm-variable">request</span>.<span class="cm-variable">getValue</span>()).</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">build</span>())</span></pre><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  .<span class="cm-variable">term</span>(<span class="cm-variable">currentTerm</span>) <span class="cm-comment">// 当前任期号</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  .<span class="cm-variable">build</span>();</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 209px;"></div><div class="CodeMirror-gutters" style="display: none; height: 209px;"></div></div></div></pre><p><span>5、然后把日志实体预提交到本地日志</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 11.0703px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 预提交到本地日志， TODO 预提交</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">logModule</span>.<span class="cm-variable">write</span>(<span class="cm-variable">logEntry</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">log</span>.<span class="cm-variable">info</span>(<span class="cm-string">"write logModule success, logEntry info : {}, log index : {}"</span>, <span class="cm-variable">logEntry</span>, <span class="cm-variable">logEntry</span>.<span class="cm-variable">getIndex</span>());</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 105px;"></div><div class="CodeMirror-gutters" style="display: none; height: 105px;"></div></div></div></pre><p><span>但是此时还没有应用到状态机中。</span></p><p><span>6、然后并行发起复制请求RPC，向其他Follower结点复制日志。并用原子类变量success保存成功的个数。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 11.0352px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 原子操作类型数据，为了保证多线程操作该数据的时候，数据得到正确的结果，因为后面会同时创建多个发起RPC复制的线程，都会对该变量进行操作</span></span></pre></div><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 因此要用原子类</span></span></pre></div><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">final</span> <span class="cm-variable">AtomicInteger</span> <span class="cm-variable">success</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">AtomicInteger</span>(<span class="cm-number">0</span>);</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 105px;"></div><div class="CodeMirror-gutters" style="display: none; height: 105px;"></div></div></div></pre><p><span>那么怎么实现并行复制呢？</span></p><p><span>采用</span></p><p>&nbsp;</p></div></div>
</body>
</html>